<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Bangla Messenger</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    /* ======================
        üé® VARIABLES (THEMING)
    ====================== */
    :root {
      /* --- LIGHT MODE (Default) --- */
      --primary-gradient: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%);
      --primary-solid: #ff758c;

      --bg-card: rgba(255, 255, 255, 0.9);
      --bg-glass-border: rgba(251, 158, 255, 0.5);

      --text-main: #2d3436;
      --text-sec: #636e72;

      --chat-header-bg: #fdf7f8;
      --chat-bg-color: #efe7dd;

      --msg-in-bg: #ffffff;
      --msg-in-text: #2d3436;
      --msg-out-text: #ffffff;

      --input-bar-bg: #fdf7f8;
      --input-field-bg: #f0f2f5;

      --shadow-soft: 0 15px 35px rgba(255, 118, 142, 0.15);

      --doodle-blend: overlay;
      --doodle-opacity: 0.15;
    }

    /* --- DARK MODE OVERRIDES --- */
    [data-theme="dark"] {
      --bg-body: #121212;
      --bg-card: rgba(68, 54, 64);
      --bg-glass-border: rgba(255, 255, 255, 0.1);

      --text-main: #e0e0e0;
      --text-sec: #b0b0b0;

      --chat-header-bg: #3f3d3b;
      --chat-bg-color: #0d0d0d;

      --msg-in-bg: #2b2b2b;
      --msg-in-text: #ffffff;

      --input-bar-bg: #3f3d3b;
      --input-field-bg: #2b2b2b;

      --shadow-soft: 0 15px 35px rgba(0, 0, 0, 0.5);

      --doodle-blend: screen;
      --doodle-opacity: 0.2;
    }

    * {
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    body,
    html {
      margin: 0;
      padding: 0;
      height: 100dvh;
      width: 100%;
      background-color: var(--bg-body);
      color: var(--text-main);
      overflow: hidden;
      transition: background-color 0.3s, color 0.3s;
    }

    /* Global Background Pattern */
    body::before {
      content: "";
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: -1;
      background-image:
        radial-gradient(at 0% 0%, hsla(340, 100%, 76%, 0.1) 0px, transparent 50%),
        radial-gradient(at 100% 100%, hsla(320, 100%, 89%, 0.1) 0px, transparent 50%);
    }

    /* ======================
        üß© COMPONENTS
    ====================== */
    button {
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(255, 117, 140, 0.25);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      letter-spacing: 0.5px;
    }

    button:active {
      transform: scale(0.96);
    }

    button.secondary-btn {
      background: transparent;
      color: var(--primary-solid);
      border: 2px solid var(--primary-solid);
      box-shadow: none;
    }

    button.danger-btn {
      background: #ff4757;
      color: white;
      box-shadow: 0 4px 10px rgba(255, 71, 87, 0.3);
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 16px 20px;
      border-radius: 20px;
      border: 1px solid var(--bg-glass-border);
      background: var(--input-field-bg);
      font-size: 15px;
      color: var(--text-main);
      margin-bottom: 15px;
      outline: none;
      transition: all 0.2s;
    }

    input:focus {
      border-color: var(--primary-solid);
      box-shadow: 0 0 0 4px rgba(255, 117, 140, 0.1);
    }

    /* Glass Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(12px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.active {
      display: flex !important;
      opacity: 1;
    }

    .box {
      background: var(--bg-card);
      padding: 35px 30px;
      width: 90%;
      max-width: 380px;
      border-radius: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
      text-align: center;
      position: relative;
      border: 1px solid var(--bg-glass-border);
      color: var(--text-main);
      max-height: 85vh;
      overflow-y: auto;
    }

    .box.animate-zoom {
      animation: zoomIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 28px;
      color: var(--text-sec);
      cursor: pointer;
      line-height: 1;
    }

    .close-btn:hover {
      color: var(--primary-solid);
    }

    /* ======================
        üè† HOME SCREEN
    ====================== */
    #home {
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      position: relative;
    }

    .home-card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      padding: 50px 30px;
      border-radius: 40px;
      box-shadow: var(--shadow-soft);
      text-align: center;
      max-width: 360px;
      width: 100%;
      border: 1px solid var(--bg-glass-border);
      animation: fadeInUp 0.8s ease-out;
    }

    .home-logo {
      font-size: 70px;
      margin-bottom: 15px;
      display: inline-block;
      animation: float 6s ease-in-out infinite;
    }

    #home h1 {
      font-size: 1.8rem;
      margin-bottom: 10px;
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }

    #home p {
      color: var(--text-sec);
      font-size: 15px;
      margin-bottom: 35px;
      line-height: 1.5;
    }

    .footer-text {
      position: absolute;
      bottom: 20px;
      font-size: 16px;
      color: var(--text-sec);
      font-weight: 500;
      text-align: center;
      width: 100%;
      opacity: 0.8;
    }

    .footer-text span {
      color: var(--primary-solid);
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes zoomIn {
      from {
        opacity: 0;
        transform: scale(0.8);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* ======================
        üë§ PROFILE PAGE
    ====================== */
    #profile {
      height: 100%;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .profile-card {
      background: var(--bg-card);
      padding: 45px 30px;
      border-radius: 35px;
      box-shadow: var(--shadow-soft);
      width: 90%;
      max-width: 350px;
      position: relative;
      border: 1px solid var(--bg-glass-border);
    }

    .avatar {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      margin: 0 auto 15px;
      padding: 4px;
      background: var(--primary-gradient);
    }

    .avatar img,
    .avatar div {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--bg-card);
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 45px;
    }

    .profile-name-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 5px;
    }

    .profile-name-container h2 {
      margin: 0;
      font-size: 24px;
      color: var(--text-main);
    }

    .edit-icon-btn {
      background: none;
      box-shadow: none;
      color: var(--primary-solid);
      padding: 5px;
      font-size: 20px;
      width: auto;
      border-radius: 50%;
      display: flex;
      align-items: center;
    }

    .status-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-bottom: 30px;
      font-size: 14px;
      color: var(--text-sec);
    }

    .green-dot {
      width: 10px;
      height: 10px;
      background-color: #2ecc71;
      border-radius: 50%;
      box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2);
    }

    .logout-btn-circle {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 71, 87, 0.1);
      color: #ff4757;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: all 0.2s;
      z-index: 20;
    }

    .logout-btn-circle:hover {
      background: #ff4757;
      color: white;
    }

    /* THEME SWITCH */
    .theme-switch {
      position: absolute;
      top: 25px;
      left: 25px;
      width: 52px;
      height: 28px;
      z-index: 20;
    }

    .theme-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #e0e0e0;
      transition: .4s;
      border-radius: 34px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 6px;
      overflow: hidden;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 3px;
      background-color: white;
      transition: .4s cubic-bezier(0.25, 0.8, 0.25, 1);
      border-radius: 50%;
      z-index: 2;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }

    .theme-switch svg {
      width: 12px;
      height: 12px;
      stroke: #636e72;
      transition: opacity 0.3s;
      z-index: 1;
    }

    input:checked+.slider {
      background-color: #2d3436;
      border-color: rgba(255, 255, 255, 0.1);
    }

    input:checked+.slider:before {
      transform: translateX(22px);
      background-color: #555;
    }

    input:checked+.slider .icon-sun {
      stroke: #aaa;
      opacity: 0.5;
    }

    input:checked+.slider .icon-moon {
      stroke: #ffffff;
      opacity: 1;
    }

    /* ======================
        üí¨ CHAT INTERFACE
    ====================== */
    #chat {
      display: none;
      height: 100dvh;
      width: 100%;
      background: var(--bg-body);
      overflow: hidden;
      flex-direction: column;
    }

    .users {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: var(--bg-card);
    }

    .users-header {
      padding: 18px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--chat-header-bg);
      backdrop-filter: blur(10px);
      z-index: 2;
      border-bottom: 1px solid var(--bg-glass-border);
    }

    .users-header h2 {
      font-size: 24px;
      color: var(--primary-solid);
      margin: 0;
      font-weight: 700;
    }

    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .users-header .secondary-btn {
      padding: 6px 14px;
      font-size: 12px;
      background: transparent;
      color: var(--primary-solid);
      border: 1px solid var(--primary-solid);
    }

    .add-group-btn {
      background: var(--primary-gradient);
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .friend-list {
      flex: 1;
      overflow-y: auto;
      padding-bottom: 10px;
    }

    .user-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      cursor: pointer;
      transition: background 0.2s;
      user-select: none;
    }

    .user-item:hover {
      background: rgba(255, 117, 140, 0.05);
    }

    .user-info-group {
      display: flex;
      align-items: center;
      flex: 1;
    }

    .user-item img,
    .user-item .placeholder {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 15px;
      background: #eee;
      flex-shrink: 0;
    }

    .user-item .placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .user-item span {
      font-weight: 600;
      font-size: 16px;
      color: var(--text-main);
    }

    .group-tag {
      font-size: 10px;
      background: var(--primary-solid);
      color: white;
      padding: 2px 6px;
      border-radius: 8px;
      margin-left: 8px;
      vertical-align: middle;
    }

    .user-options-btn {
      background: none;
      box-shadow: none;
      padding: 5px;
      color: var(--text-sec);
      font-size: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 35px;
      height: 35px;
    }

    /* Chatbox */
    .chatbox {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
      background: var(--bg-body);
      position: relative;
    }

    .chatbox::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url("img/space-5654794_1280.webp");
      background-size: 300px;
      background-repeat: repeat;
      opacity: var(--doodle-opacity);
      pointer-events: none;
      z-index: 0;
      mix-blend-mode: var(--doodle-blend);
    }

    .chat-header {
      height: 70px;
      padding: 0 15px;
      background: var(--chat-header-bg);
      backdrop-filter: blur(15px);
      border-bottom: 1px solid var(--bg-glass-border);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
      z-index: 10;
      position: relative;
    }

    .back-btn {
      background: none;
      border: none;
      padding: 0;
      color: var(--primary-solid);
      font-size: 26px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      box-shadow: none;
    }

    .chat-avatar {
      width: 44px;
      height: 44px;
      flex-shrink: 0;
      border-radius: 50%;
      overflow: hidden;
      cursor: pointer;
    }

    .chat-avatar img,
    .chat-avatar div {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .chat-avatar div {
      background: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-info h3 {
      margin: 0;
      font-size: 17px;
      font-weight: 600;
      line-height: 1.2;
      color: var(--text-main);
    }

    .chat-info span {
      font-size: 12px;
      color: var(--text-sec);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .chat-options-container {
      margin-left: auto;
      position: relative;
    }

    .chat-menu-btn {
      background: none;
      box-shadow: none;
      border: none;
      font-size: 24px;
      color: var(--primary-solid);
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-dropdown {
      position: absolute;
      top: 50px;
      right: 0;
      width: 240px;
      background: var(--bg-card);
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 100;
      border: 1px solid var(--bg-glass-border);
      padding-top: 10px;
      padding-bottom: 10px;
      animation: fadeInMenu 0.2s ease-out forwards;
    }

    @keyframes fadeInMenu {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .chat-dropdown.active {
      display: flex;
    }

    .dropdown-item {
      padding: 12px 20px;
      font-size: 14px;
      color: var(--text-main);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-weight: 500;
      box-shadow: none;
    }

    .dropdown-item:hover {
      background: rgba(255, 117, 140, 0.1);
      color: var(--primary-solid);
    }

    .dropdown-item.danger {
      color: #ff4757;
    }

    .messages {
      flex: 1;
      padding: 15px 15px 60px 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      z-index: 1;
    }

    /* Date and Time Separators */
    .date-separator, .time-separator {
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-sec);
      text-transform: uppercase;
      background: var(--bg-card);
      padding: 4px 12px;
      border-radius: 12px;
      align-self: center;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      margin: 15px 0 5px;
    }
    
    /* Time Separator (Specific Override) */
    .time-separator {
      margin: 5px 0 2px;
      font-size: 10px;
      font-weight: 500;
      background: transparent;
      box-shadow: none;
      padding: 0;
      opacity: 0.8;
      text-transform: none;
    }

    /* Messages Row */
    .msg-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      max-width: 85%;
      position: relative;
    }

    .msg-row.me {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .msg-row.other {
      align-self: flex-start;
      flex-direction: row;
    }

    .msg-row.hidden-by-search {
      display: none !important;
    }

    /* Group Avatar in Chat */
    .msg-avatar-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
      background: #ddd;
      margin-bottom: 2px;
    }

    .msg-avatar-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .msg-avatar-icon div {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #555;
    }

    /* System Message */
    .system-msg {
      align-self: center;
      font-size: 11px;
      color: var(--text-sec);
      background: rgba(0, 0, 0, 0.05);
      padding: 4px 12px;
      border-radius: 10px;
      margin: 5px 0;
      text-align: center;
      max-width: 90%;
    }

    .msg-bubble {
      padding: 10px 16px;
      font-size: 15px;
      line-height: 1.4;
      position: relative;
      word-wrap: break-word;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      border-radius: 20px;
      /* min-width: 60px; Removed to fit content better */
    }

    .msg-row.me .msg-bubble {
      background: var(--primary-gradient);
      color: var(--msg-out-text);
      border-bottom-right-radius: 4px;
      box-shadow: 0 4px 15px rgba(255, 117, 140, 0.2);
    }

    .msg-row.other .msg-bubble {
      background: var(--msg-in-bg);
      color: var(--msg-in-text);
      border-bottom-left-radius: 4px;
    }

    .msg-bubble img {
      border-radius: 12px;
      margin-top: 5px;
      max-width: 100%;
      display: block;
    }
    
    .msg-sender-name {
      font-size: 11px;
      color: var(--text-sec);
      margin-bottom: 2px;
      font-weight: 600;
      margin-left: 2px;
    }

    .like-msg {
      font-size: 35px;
      background: none !important;
      box-shadow: none !important;
      padding: 0;
    }

    .msg-menu-container {
      position: relative;
      opacity: 0;
      transition: opacity 0.2s;
      width: 20px;
      display: flex;
      justify-content: center;
      align-self: center;
    }

    .msg-row:hover .msg-menu-container {
      opacity: 1;
    }

    .msg-dots-btn {
      background: none;
      border: none;
      font-size: 18px;
      color: var(--text-sec);
      cursor: pointer;
      padding: 0;
      box-shadow: none;
    }

    .msg-delete-popup {
      position: absolute;
      top: -25px;
      background: var(--bg-card);
      padding: 5px 10px;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      display: none;
      z-index: 20;
      font-size: 12px;
      color: #ff4757;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }

    .typing-indicator {
      position: absolute;
      bottom: 80px;
      left: 20px;
      z-index: 10;
      background: var(--msg-in-bg);
      padding: 12px 18px;
      border-radius: 20px;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      display: none;
      align-items: center;
      justify-content: center;
      width: fit-content;
      min-width: 60px;
      height: 45px;
    }

    .typing-dots {
      display: flex;
      align-items: center;
      gap: 4px;
      height: 100%;
    }

    .typing-dots span {
      width: 7px;
      height: 7px;
      background: var(--primary-solid);
      display: inline-block;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .typing-dots span:nth-child(1) {
      animation-delay: -0.32s;
    }

    .typing-dots span:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes bounce {

      0%,
      80%,
      100% {
        transform: scale(0);
      }

      40% {
        transform: scale(1);
      }
    }

    .input-bar {
      min-height: 70px;
      padding: 10px 15px;
      background: var(--input-bar-bg);
      display: flex;
      align-items: center;
      gap: 10px;
      border-top: 1px solid var(--bg-glass-border);
      flex-shrink: 0;
      z-index: 20;
    }

    .icon-btn {
      background: none;
      border: none;
      width: 44px;
      height: 44px;
      font-size: 24px;
      cursor: pointer;
      color: var(--primary-solid);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: none;
      flex-shrink: 0;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .icon-btn:hover {
      background: rgba(255, 117, 140, 0.1);
    }

    .input-wrapper {
      flex: 1;
      background: var(--input-field-bg);
      border-radius: 24px;
      display: flex;
      align-items: center;
      padding: 0 15px;
      height: 46px;
      transition: background 0.2s;
    }

    .input-wrapper:focus-within {
      background: var(--input-field-bg);
      border: 1px solid var(--primary-solid);
    }

    .input-wrapper input {
      width: 100%;
      background: transparent;
      border: none;
      padding: 0;
      margin: 0;
      font-size: 16px;
      color: var(--text-main);
      height: 100%;
    }

    .input-wrapper input:focus {
      box-shadow: none;
    }

    #sendBtn,
    #likeBtn {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      flex-shrink: 0;
      box-shadow: none;
    }

    #likeBtn {
      background: transparent;
      font-size: 32px;
      color: var(--primary-solid);
    }

    #sendBtn {
      background: var(--primary-gradient);
      color: white;
      font-size: 18px;
      display: none;
      box-shadow: 0 4px 12px rgba(255, 117, 140, 0.4);
    }

    .hidden {
      display: none !important;
    }

    #fileInput {
      display: none;
    }

    .show-users .users {
      display: flex;
    }

    .show-users .chatbox {
      display: none;
    }

    .show-chat .users {
      display: none;
    }

    .show-chat .chatbox {
      display: flex;
    }

    #filePreviewName {
      font-size: 10px;
      color: var(--primary-solid);
      font-weight: 600;
      max-width: 60px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .login-head {
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 30px;
    }

    /* Context Menu */
    .context-menu {
      position: fixed;
      background: var(--bg-card);
      border: 1px solid var(--bg-glass-border);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      padding: 5px 0;
      z-index: 2000;
      display: none;
      flex-direction: column;
      min-width: 150px;
    }

    .context-menu.active {
      display: flex;
    }

    .context-item {
      padding: 10px 15px;
      font-size: 14px;
      cursor: pointer;
      color: var(--text-main);
    }

    .context-item:hover {
      background: rgba(255, 117, 140, 0.1);
      color: var(--primary-solid);
    }

    /* Group Member List Styles */
    .member-list {
      text-align: left;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--bg-glass-border);
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .member-row {
      padding: 10px 12px;
      border-bottom: 1px solid var(--bg-glass-border);
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .member-info {
      display: flex;
      flex-direction: column;
    }

    .member-role {
      font-size: 10px;
      color: #aaa;
      margin-top: 2px;
    }

    .role-admin {
      color: #ff758c;
      font-weight: 700;
    }

    .btn-small {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 5px;
      background: #eee;
      color: #555;
      border: none;
    }

    .btn-remove {
      background: rgba(255, 71, 87, 0.1);
      color: #ff4757;
    }

    .chat-search-bar {
      display: none;
      padding: 10px 15px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--bg-glass-border);
      animation: slideDown 0.2s ease-out;
      flex-shrink: 0;
      position: relative;
    }

    .chat-search-bar.active {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chat-search-bar input {
      flex: 1;
      padding: 8px 15px;
      border-radius: 20px;
      border: 1px solid var(--bg-glass-border);
      font-size: 14px;
      outline: none;
      background: var(--input-field-bg);
      margin: 0;
      color: var(--text-main);
    }

    .close-search-btn {
      background: none;
      border: none;
      color: #ff4757;
      box-shadow: none;
      padding: 5px;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-10px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .updateGroupInfo{
      margin-top: 20px;
    }
  </style>
</head>

<body>

  <div id="home">
    <div class="home-card">
      <div class="home-logo">üå∏</div>
      <h1>Bangla Messenger</h1>
      <p>Connect with your friends in a simple & aesthetic way.</p>
      <button id="startBtn">Get Started</button>
    </div>
    <div class="footer-text">Made with ‚ù§Ô∏è by <span>Nafis</span></div>
  </div>

  <div id="loginModal" class="modal-overlay" style="display: none;">
    <div class="box">
      <span class="close-btn" onclick="closeLoginAndShowHome()">&times;</span>
      <h2 class="login-head">Welcome Back üíñ</h2>
      <p style="color:#888; margin-bottom: 20px;">Login or Sign up to Join</p>
      <input id="username" type="text" placeholder="Username" />
      <input id="password" type="password" placeholder="Password" />
      <button id="loginBtn" style="width:100%">Continue</button>
    </div>
  </div>

  <div id="profile" style="display: none;">
    <div class="profile-card">
      <label class="theme-switch">
        <input type="checkbox" id="themeCheckbox" onchange="handleThemeToggle(this)">
        <span class="slider">
          <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
          <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
        </span>
      </label>

      <button id="logoutBtn" class="logout-btn-circle" title="Logout">‚õî</button>

      <div class="avatar" id="myAvatarDisplay">
        <div>üë§</div>
      </div>
      <div class="profile-name-container">
        <h2 id="profileNameDisplay">User</h2>
        <button id="openEditProfileBtn" class="edit-icon-btn" title="Edit Profile">‚úé</button>
      </div>

      <div class="status-container">
        <div class="green-dot"></div><span>Online</span>
      </div>

      <div style="display:flex; flex-direction:column; gap:12px;">
        <button id="addFriendBtn" class="secondary-btn">Add Friend</button>
        <button id="goToChatsBtn">Go to Chats üí¨</button>
      </div>
    </div>
  </div>

  <div id="editProfileModal" class="modal-overlay" style="display: none;">
    <div class="box">
      <span class="close-btn" onclick="closeModal('editProfileModal')">&times;</span>
      <h3>Update Profile</h3>
      <input type="text" id="newUsernameInput" placeholder="New Username" />
      <input type="text" id="newPhotoUrlInput" placeholder="Profile Image URL" />
      <p style="font-size:13px; color:#aaa; margin:10px 0;">OR Upload Image</p>
      <input type="file" id="profilePicUpload" style="font-size:14px;" />
      <button id="saveProfileBtn" style="margin-top:20px; width:100%;">Save Changes</button>
    </div>
  </div>

  <div id="addFriendModal" class="modal-overlay" style="display: none;">
    <div class="box">
      <span class="close-btn" onclick="closeModal('addFriendModal')">&times;</span>
      <h3>Add Friend</h3>
      <p style="color:#888; font-size:14px; margin-bottom:15px;">Search by username</p>
      <input type="text" id="friendUsernameInput" placeholder="Exact Username" />
      <button id="searchFriendBtn" style="width:100%;">Add User</button>
    </div>
  </div>

  <div id="createGroupModal" class="modal-overlay" style="display: none;">
    <div class="box">
      <span class="close-btn" onclick="closeModal('createGroupModal')">&times;</span>
      <h3>Create Group</h3>
      <input type="text" id="groupNameInput" placeholder="Group Name" />
      <p style="font-size:13px; color:#aaa; margin:10px 0;">Group Icon (Optional)</p>
      <input type="file" id="groupIconUpload" style="font-size:14px; margin-bottom:15px;" />
      <button id="doCreateGroupBtn" style="width:100%;">Create</button>
    </div>
  </div>

  <div id="manageGroupModal" class="modal-overlay" style="display: none;">
    <div class="box">
      <span class="close-btn" onclick="closeModal('manageGroupModal')">&times;</span>
      <h3>Manage Group</h3>
      <div id="manageGroupContent"></div>
    </div>
  </div>

  <div id="deleteChatModal" class="modal-overlay" style="display: none;">
    <div class="box">
      <span class="close-btn" onclick="closeModal('deleteChatModal')">&times;</span>
      <h3 style="color:#ff4757;">Remove Friend?</h3>
      <p style="color:#666; font-size:14px; margin-bottom:20px;">
        This will remove <b id="deleteTargetName">User</b> from your chat list.
      </p>
      <button id="confirmDeleteBtn" class="danger-btn" style="width:100%;">Yes, Remove</button>
    </div>
  </div>

  <div id="friendProfileModal" class="modal-overlay" style="display: none;">
    <div class="box">
      <span class="close-btn" onclick="closeModal('friendProfileModal')">&times;</span>
      <div class="avatar" id="friendModalAvatar" style="width:100px; height:100px; margin-bottom:15px;"></div>
      <h3 id="friendModalName" style="margin-bottom:5px;">User</h3>
      <p style="color:#aaa; font-size:14px;">Bangla Messenger User</p>
    </div>
  </div>

  <div id="userContextMenu" class="context-menu">
    <div class="context-item" id="ctxCreateGroup">Create Group</div>
  </div>

  <div id="chat" class="show-users" style="display: none;">

    <div class="users">
      <div class="users-header">
        <h2>Chats</h2>
        <div class="header-actions">
          <button class="add-group-btn" onclick="openCreateGroupModal()" title="New Group">+</button>
          <button onclick="goToProfile()" class="secondary-btn">Profile</button>
        </div>
      </div>
      <div id="friendsListContainer" class="friend-list"></div>
    </div>

    <div class="chatbox">
      <div class="chat-header">
        <button class="back-btn" onclick="backToFriends()">‚Üê</button>
        <div class="chat-avatar" id="chatHeaderIcon" onclick="showFriendProfile()"></div>
        <div class="chat-info">
          <h3 id="chatHeaderName">User</h3>
          <span id="chatHeaderStatus">Active now</span>
        </div>

        <div class="chat-options-container">
          <button class="chat-menu-btn" onclick="toggleChatMenu()">‚ãÆ</button>
          <div class="chat-dropdown" id="chatMenuDropdown">
          </div>
        </div>
      </div>

      <div class="chat-search-bar" id="chatSearchBar">
        <input type="text" id="messageSearchInput" placeholder="Search..." oninput="filterMessages()" />
        <button class="close-search-btn" onclick="closeSearch()" title="Close Search">‚úñ</button>
      </div>

      <div class="messages" id="messages"></div>

      <div class="typing-indicator" id="typingIndicator">
        <div class="typing-dots"><span></span><span></span><span></span></div>
      </div>

      <div class="input-bar">
        <input type="file" id="fileInput" onchange="handleFileSelect()" />
        <label for="fileInput" class="icon-btn" title="Send File">üìé</label>

        <span id="filePreviewName"></span>

        <div class="input-wrapper">
          <input id="msgInput" type="text" placeholder="Type a message..." autocomplete="off" oninput="handleInput()" />
        </div>

        <button id="likeBtn" class="icon-btn" onclick="sendLike()">üëç</button>
        <button id="sendBtn" onclick="sendMessage()">‚û§</button>
      </div>
    </div>
  </div>

  <script>
    firebase.initializeApp({
      apiKey: "AIzaSyDEdvwTvt-tSuWt5cJN5vInxWhm5gCuefo",
      authDomain: "cryptchat-web.firebaseapp.com",
      projectId: "cryptchat-web"
    });
    const db = firebase.firestore();
    const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dpv173a1d/auto/upload";
    const CLOUDINARY_PRESET = "unsigned_preset";

    let currentUser = null;
    let currentChatEntity = null; // Friend or Group object
    let currentChatType = null; // 'direct' or 'group'
    let currentGroupMembersCache = {}; // Store {uid: {username, photoUrl, role}} for current group

    let unsubscribeFriends = null;
    let unsubscribeGroups = null;
    let unsubscribeMsgs = null;
    let unsubscribeTyping = null;

    let typingTimeout = null;
    let friendToDelete = null;
    let myFriendsList = [];

    // --- THEME ---
    function handleThemeToggle(checkbox) {
      const target = checkbox.checked ? "dark" : "light";
      document.documentElement.setAttribute("data-theme", target);
      localStorage.setItem("theme", target);
    }
    window.addEventListener("DOMContentLoaded", () => {
      const savedTheme = localStorage.getItem("theme");
      const checkbox = document.getElementById("themeCheckbox");
      if (savedTheme === "dark") { checkbox.checked = true; document.documentElement.setAttribute("data-theme", "dark"); }
      else { checkbox.checked = false; document.documentElement.setAttribute("data-theme", "light"); }

      const storedId = localStorage.getItem("uid");
      if (storedId) fetchUser(storedId);
      else document.getElementById("home").style.display = "flex";

      // --- ENTER KEY LISTENERS ---
      document.getElementById("username").addEventListener("keypress", function (event) {
        if (event.key === "Enter") document.getElementById("loginBtn").click();
      });
      document.getElementById("password").addEventListener("keypress", function (event) {
        if (event.key === "Enter") document.getElementById("loginBtn").click();
      });
      document.getElementById("msgInput").addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
          event.preventDefault(); 
          sendMessage();
        }
      });
    });

    // --- UTILS ---
    function toTitleCase(str) { return str ? str.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') : ""; }
    function closeModal(id) { document.getElementById(id).classList.remove("active"); }

    // --- AUTH ---
    document.getElementById("startBtn").onclick = () => {
      document.getElementById("loginModal").classList.add("active");
      document.querySelector("#loginModal .box").classList.add("animate-zoom");
    };
    function closeLoginAndShowHome() {
      document.getElementById("loginModal").classList.remove("active");
      document.getElementById("home").style.display = "flex";
    }
    document.getElementById("loginBtn").onclick = async () => {
      const u = document.getElementById("username").value.trim().toLowerCase();
      const p = document.getElementById("password").value;
      if (!u || !p) return alert("Please fill fields");
      const snap = await db.collection("users").where("username", "==", u).get();
      if (!snap.empty) {
        if (snap.docs[0].data().password === p) fetchUser(snap.docs[0].id);
        else alert("Wrong password");
      } else {
        const ref = await db.collection("users").add({ username: u, password: p, photoUrl: "", friends: [], created: firebase.firestore.FieldValue.serverTimestamp() });
        fetchUser(ref.id);
      }
    };
    async function fetchUser(uid) {
      const doc = await db.collection("users").doc(uid).get();
      if (doc.exists) {
        currentUser = { id: doc.id, ...doc.data() };
        currentUser.username = toTitleCase(currentUser.username);
        localStorage.setItem("uid", uid);
        document.getElementById("loginModal").classList.remove("active");
        showChatInbox();
      } else { localStorage.clear(); location.reload(); }
    }
    document.getElementById("logoutBtn").onclick = () => {
      if (confirm("Log out?")) { localStorage.clear(); location.reload(); }
    };

    // --- NAVIGATION ---
    function showChatInbox() {
      document.getElementById("home").style.display = "none";
      document.getElementById("profile").style.display = "none";
      document.getElementById("chat").style.display = "flex";
      backToFriends();
      setupSidebarData();
    }
    function goToProfile() {
      document.getElementById("chat").style.display = "none";
      document.getElementById("profile").style.display = "flex";
      document.getElementById("profileNameDisplay").textContent = currentUser.username;
      const av = document.getElementById("myAvatarDisplay");
      av.innerHTML = currentUser.photoUrl ? `<img src="${currentUser.photoUrl}" />` : `<div>üë§</div>`;
    }
    document.getElementById("goToChatsBtn").onclick = showChatInbox;

    // --- SIDEBAR ---
    function setupSidebarData() {
      if (unsubscribeFriends) return;
      unsubscribeFriends = db.collection("users").doc(currentUser.id).onSnapshot(async (doc) => {
        const data = doc.data();
        currentUser.friends = data.friends || [];
        if (currentUser.friends.length > 0) {
          // Fetch friends and filter out any that might have been deleted
          const promises = currentUser.friends.map(fid => db.collection("users").doc(fid).get());
          const docs = await Promise.all(promises);
          myFriendsList = docs
            .filter(d => d.exists) // IMPORTANT: Filter out deleted users
            .map(d => ({ id: d.id, ...d.data(), type: 'direct' }));
        } else { myFriendsList = []; }
        renderSidebar();
      });
      unsubscribeGroups = db.collection("groups").where("members", "array-contains", currentUser.id).onSnapshot(snap => {
        window.myGroupsList = snap.docs.map(d => ({ id: d.id, ...d.data(), type: 'group' }));
        renderSidebar();
      });
    }
    function renderSidebar() {
      const container = document.getElementById("friendsListContainer");
      container.innerHTML = "";
      const combined = [...(window.myGroupsList || []), ...myFriendsList];
      if (combined.length === 0) { container.innerHTML = "<div style='text-align:center;margin-top:40px;color:var(--text-sec);'>No chats yet.<br>Click Profile to add friends.</div>"; return; }

      combined.forEach(item => {
        const div = document.createElement("div"); div.className = "user-item";
        const isGroup = item.type === 'group';
        const name = isGroup ? item.name : toTitleCase(item.username);
        const imgHtml = item.photoUrl ? `<img src="${item.photoUrl}">` : `<div class="placeholder">${isGroup ? 'üë•' : 'üë§'}</div>`;
        div.innerHTML = `<div class="user-info-group">${imgHtml}<div><span>${name}</span>${isGroup ? `<span class="group-tag">Group</span>` : ''}</div></div>`;

        if (!isGroup) {
          const menuBtn = document.createElement("button"); menuBtn.className = "user-options-btn"; menuBtn.innerHTML = "‚ãÆ";
          menuBtn.onclick = (e) => { e.stopPropagation(); showDeleteModal(item.id, item.username); };
          div.appendChild(menuBtn);
          div.oncontextmenu = (e) => { e.preventDefault(); showContextForCreateGroup(e, item); };
        }
        
        // Pass the entire item object to openChat to ensure ID is present
        div.onclick = () => openChat(item, item.type);
        container.appendChild(div);
      });
    }

    // --- CHAT LOGIC ---
    async function openChat(entity, type) {
      if (!entity || !entity.id) return console.error("Invalid chat entity");
      currentChatEntity = entity;
      currentChatType = type;
      currentGroupMembersCache = {}; 

      document.getElementById("chat").classList.remove("show-users");
      document.getElementById("chat").classList.add("show-chat");

      const name = type === 'group' ? entity.name : toTitleCase(entity.username);
      document.getElementById("chatHeaderName").textContent = name;
      const iconDiv = document.getElementById("chatHeaderIcon");
      if (entity.photoUrl) iconDiv.innerHTML = `<img src="${entity.photoUrl}">`;
      else iconDiv.innerHTML = `<div style="font-size:24px;">${type === 'group' ? 'üë•' : 'üë§'}</div>`;

      if (type === 'group') {
        const memberIds = entity.members || [];
        const promises = memberIds.map(uid => db.collection("users").doc(uid).get());
        const docs = await Promise.all(promises);
        docs.forEach(d => { if (d.exists) currentGroupMembersCache[d.id] = d.data(); });
      }

      updateChatDropdown();
      if (type === 'direct') setupTypingListener();
      else document.getElementById("typingIndicator").style.display = "none";
      loadMessages();
    }

    function loadMessages() {
      if (unsubscribeMsgs) unsubscribeMsgs();
      const msgsDiv = document.getElementById("messages");

      let ref;
      // Robust Chat ID Generation
      if (currentChatType === 'direct') {
        // Ensure IDs are valid before joining
        if(!currentUser.id || !currentChatEntity.id) {
           alert("Error: Chat ID invalid. Please refresh.");
           return;
        }
        ref = db.collection("chats").doc([currentUser.id, currentChatEntity.id].sort().join("_")).collection("msgs");
      }
      else ref = db.collection("groups").doc(currentChatEntity.id).collection("msgs");

      unsubscribeMsgs = ref.orderBy("time").onSnapshot(snap => {
        msgsDiv.innerHTML = "";
        let lastDate = null;
        let lastTimeStr = null; 
        
        snap.forEach(doc => {
          const m = doc.data();
          // DATE LOGIC
          const date = m.time ? m.time.toDate() : new Date();
          const dateStr = date.toDateString();
          // TIME LOGIC (Formatted)
          const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

          // 1. DATE SEPARATOR
          if (dateStr !== lastDate) {
            const sep = document.createElement("div"); sep.className = "date-separator";
            const today = new Date().toDateString();
            const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
            
            if(dateStr === today) sep.textContent = "Today";
            else if(dateStr === yesterday.toDateString()) sep.textContent = "Yesterday";
            else sep.textContent = date.toLocaleDateString();
            
            msgsDiv.appendChild(sep); 
            lastDate = dateStr;
            lastTimeStr = null; // Reset time tracking on new day
          }

          // 2. TIME SEPARATOR (ABOVE MIDDLE)
          if (timeStr !== lastTimeStr) {
             const tSep = document.createElement("div");
             tSep.className = "time-separator";
             tSep.textContent = timeStr;
             msgsDiv.appendChild(tSep);
             lastTimeStr = timeStr;
          }

          if (m.type === 'system') {
            const sysDiv = document.createElement("div"); sysDiv.className = "system-msg"; sysDiv.textContent = m.content;
            msgsDiv.appendChild(sysDiv); return;
          }

          const rowDiv = document.createElement("div");
          const isMe = m.sender === currentUser.id;
          rowDiv.className = "msg-row " + (isMe ? "me" : "other");

          let senderIconHTML = "";
          let displayName = "";

          if (!isMe && currentChatType === 'group') {
            const senderData = currentGroupMembersCache[m.sender] || {};
            const avatar = senderData.photoUrl ? `<img src="${senderData.photoUrl}">` : `<div>${(senderData.username || "?").charAt(0).toUpperCase()}</div>`;
            senderIconHTML = `<div class="msg-avatar-icon">${avatar}</div>`;
            const nicknames = currentChatEntity.nicknames || {};
            const nick = nicknames[m.sender];
            const realName = toTitleCase(senderData.username || "User");
            displayName = `<div class="msg-sender-name">${nick || realName}</div>`;
          }

          let bubbleContent = "";
          if (m.type === "text") bubbleContent = m.content;
          else if (m.type === "file") bubbleContent = `<img src="${m.url}">`;
          else if (m.type === "like") bubbleContent = "üëç";

          const bubbleClass = m.type === 'like' ? "msg-bubble like-msg" : "msg-bubble";
          const menuHTML = `<div class="msg-menu-container"><button class="msg-dots-btn">‚ãÆ</button><div class="msg-delete-popup" onclick="deleteMessage('${doc.ref.path}')">Delete</div></div>`;

          let finalHTML = "";
          if (isMe) {
            finalHTML = `
                <div class="${bubbleClass}">
                    ${bubbleContent}
                </div>
                ${menuHTML}
            `;
          } else {
            finalHTML = `
                ${senderIconHTML}
                <div style="display:flex; flex-direction:column;">
                    ${displayName}
                    <div class="${bubbleClass}">
                        ${bubbleContent}
                    </div>
                </div>
                ${menuHTML}
            `;
          }

          rowDiv.innerHTML = finalHTML;
          const btn = rowDiv.querySelector('.msg-dots-btn');
          const popup = rowDiv.querySelector('.msg-delete-popup');
          if (btn) btn.onclick = () => { popup.style.display = popup.style.display === 'block' ? 'none' : 'block'; };

          msgsDiv.appendChild(rowDiv);
        });
        msgsDiv.scrollTop = msgsDiv.scrollHeight;
        filterMessages();
      });
    }

    async function sendMessage() {
      const input = document.getElementById("msgInput");
      const txt = input.value.trim();
      const file = document.getElementById("fileInput").files[0];
      
      if (!txt && !file) return;

      // Optimistic UI Clear
      input.value = "";
      toggleSendBtn(); 

      let ref;
      if (currentChatType === 'direct') {
        // Ensure IDs are valid before joining
        if(!currentUser.id || !currentChatEntity.id) {
           alert("Error: Chat ID invalid. Please refresh.");
           return;
        }
        ref = db.collection("chats").doc([currentUser.id, currentChatEntity.id].sort().join("_")).collection("msgs");
      }
      else ref = db.collection("groups").doc(currentChatEntity.id).collection("msgs");

      const base = { sender: currentUser.id, time: firebase.firestore.FieldValue.serverTimestamp() };
      
      try {
          if (file) {
            const url = await uploadToCloudinary(file);
            await ref.add({ ...base, type: "file", url: url });
            document.getElementById("fileInput").value = ""; document.getElementById("filePreviewName").textContent = "";
          }
          if (txt) { 
              await ref.add({ ...base, type: "text", content: txt }); 
          }
      } catch(e) {
          console.error("Send Error", e);
          alert("Failed to send message.");
      }
    }

    async function sendSystemMessage(text) {
      if (currentChatType !== 'group') return;
      await db.collection("groups").doc(currentChatEntity.id).collection("msgs").add({
        type: 'system', content: text, time: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    async function sendLike() {
      const base = { sender: currentUser.id, type: "like", time: firebase.firestore.FieldValue.serverTimestamp() };
      if (currentChatType === 'direct') await db.collection("chats").doc([currentUser.id, currentChatEntity.id].sort().join("_")).collection("msgs").add(base);
      else await db.collection("groups").doc(currentChatEntity.id).collection("msgs").add(base);
    }
    async function deleteMessage(path) { if (confirm("Delete?")) await db.doc(path).delete(); }

    // --- GROUP MANAGEMENT ---
    function updateChatDropdown() {
      const menu = document.getElementById("chatMenuDropdown");
      menu.innerHTML = "";
      if (currentChatType === 'direct') {
        menu.innerHTML = `
          <button class="dropdown-item" onclick="showFriendProfile();toggleChatMenu()">üë§ Profile</button>
          <button class="dropdown-item" onclick="toggleSearch();toggleChatMenu()">üîç Search</button>
          <button class="dropdown-item" onclick="alert('üîí Privacy: End-to-end encryption is enabled.');toggleChatMenu()">üîí Privacy</button>
          <button class="dropdown-item danger" onclick="deleteConversation();toggleChatMenu()">üóëÔ∏è Delete</button>
        `;
      } else {
        const isAdmin = currentChatEntity.admin === currentUser.id;
        menu.innerHTML = `<button class="dropdown-item" onclick="toggleSearch();toggleChatMenu()">üîç Search</button><button class="dropdown-item" onclick="openManageGroup('members');toggleChatMenu()">üë• Members / Nicknames</button>`;
        menu.innerHTML += `<button class="dropdown-item" onclick="alert('üîí Privacy: This is a private group.');toggleChatMenu()">üîí Privacy</button>`;

        if (isAdmin) {
          menu.innerHTML += `<button class="dropdown-item" onclick="openManageGroup('add');toggleChatMenu()">‚ûï Add Member</button><button class="dropdown-item" onclick="openManageGroup('edit');toggleChatMenu()">‚úé Edit Info</button><button class="dropdown-item danger" onclick="deleteGroup();toggleChatMenu()">üóë Delete Group</button>`;
        } else {
          menu.innerHTML += `<button class="dropdown-item danger" onclick="leaveGroup();toggleChatMenu()">üö™ Leave Group</button>`;
        }
      }
    }

    function openManageGroup(mode) {
      const modal = document.getElementById("manageGroupModal");
      const content = document.getElementById("manageGroupContent");
      modal.classList.add("active"); modal.querySelector(".box").classList.add("animate-zoom");
      content.innerHTML = "";

      if (mode === 'add') {
        content.innerHTML = `<p>Add Member by Username</p><input type="text" id="groupAddUserInput" placeholder="Username"/><button onclick="addGroupMember()" style="width:100%">Add</button>`;
      } else if (mode === 'edit') {
        content.innerHTML = `<p>Group Name</p><input type="text" id="groupEditNameInput" value="${currentChatEntity.name}" /><p>Group Icon</p><input type="file" id="groupEditIconInput" /><button class="updateGroupInfo" onclick="updateGroupInfo()" style="width:100%">Save</button>`;
      } else if (mode === 'members') {
        content.innerHTML = `<p>Members & Nicknames</p><div id="groupMemberList" class="member-list">Loading...</div>`;
        renderMembersList();
      }
    }

    async function renderMembersList() {
      const list = document.getElementById("groupMemberList");
      list.innerHTML = "";
      const isAdminMe = currentChatEntity.admin === currentUser.id;

      for (const uid of currentChatEntity.members) {
        let uData = currentGroupMembersCache[uid];
        if (!uData) {
          const doc = await db.collection("users").doc(uid).get();
          uData = doc.data();
          currentGroupMembersCache[uid] = uData;
        }

        const isOwner = currentChatEntity.admin === uid;
        const currentNick = (currentChatEntity.nicknames && currentChatEntity.nicknames[uid]) || "";

        const row = document.createElement("div"); row.className = "member-row";

        let roleHtml = isOwner ? `<span class="member-role role-admin">Admin</span>` : `<span class="member-role">Member</span>`;
        let actionsHtml = "";
        actionsHtml += `<button class="btn-small" onclick="setNickname('${uid}', '${toTitleCase(uData.username)}')">Nick</button>`;
        if (isAdminMe && !isOwner) {
          actionsHtml += `<button class="btn-small btn-remove" onclick="removeMember('${uid}', '${toTitleCase(uData.username)}')">Kick</button>`;
        }

        row.innerHTML = `
                <div class="member-info">
                    <span style="font-weight:600">${toTitleCase(uData.username)} ${currentNick ? `(${currentNick})` : ''}</span>
                    ${roleHtml}
                </div>
                <div>${actionsHtml}</div>
            `;
        list.appendChild(row);
      }
    }

    async function setNickname(uid, oldName) {
      const nick = prompt(`Set nickname for ${oldName}:`);
      if (nick === null) return;
      const nicknames = currentChatEntity.nicknames || {};
      if (nick === "") delete nicknames[uid];
      else nicknames[uid] = nick;

      await db.collection("groups").doc(currentChatEntity.id).update({ nicknames: nicknames });
      currentChatEntity.nicknames = nicknames;
      renderMembersList();
    }

    async function addGroupMember() {
      const uname = document.getElementById("groupAddUserInput").value.trim().toLowerCase();
      if (!uname) return;
      const snap = await db.collection("users").where("username", "==", uname).get();
      if (snap.empty) return alert("User not found");

      const newUid = snap.docs[0].id;
      const newName = toTitleCase(snap.docs[0].data().username);
      if (currentChatEntity.members.includes(newUid)) return alert("Already in group");

      const newMembers = [...currentChatEntity.members, newUid];
      await db.collection("groups").doc(currentChatEntity.id).update({ members: newMembers });
      await sendSystemMessage(`${currentUser.username} added ${newName}`);
      currentChatEntity.members = newMembers;
      alert("Added!"); closeModal("manageGroupModal");
      currentGroupMembersCache[newUid] = snap.docs[0].data();
    }

    async function removeMember(uid, name) {
      if (!confirm(`Remove ${name}?`)) return;
      const newMembers = currentChatEntity.members.filter(m => m !== uid);
      await db.collection("groups").doc(currentChatEntity.id).update({ members: newMembers });
      await sendSystemMessage(`${name} was removed by Admin`);
      currentChatEntity.members = newMembers;
      renderMembersList();
    }

    async function leaveGroup() {
      if (!confirm("Leave group?")) return;
      const newMembers = currentChatEntity.members.filter(m => m !== currentUser.id);
      await db.collection("groups").doc(currentChatEntity.id).update({ members: newMembers });
      await sendSystemMessage(`${currentUser.username} left the group`);
      backToFriends();
    }

    async function deleteGroup() {
      if (!confirm("Delete group permanently?")) return;
      await db.collection("groups").doc(currentChatEntity.id).delete();
      backToFriends();
    }

    async function updateGroupInfo() {
      const newName = document.getElementById("groupEditNameInput").value.trim();
      const file = document.getElementById("groupEditIconInput").files[0];
      let data = { name: newName };
      if (file) data.photoUrl = await uploadToCloudinary(file);
      await db.collection("groups").doc(currentChatEntity.id).update(data);
      currentChatEntity.name = newName;
      if (data.photoUrl) currentChatEntity.photoUrl = data.photoUrl;
      document.getElementById("chatHeaderName").textContent = newName;
      closeModal("manageGroupModal");
    }

    // --- Create Group & Context Menu ---
    function openCreateGroupModal() { document.getElementById("createGroupModal").classList.add("active"); }
    document.getElementById("doCreateGroupBtn").onclick = async () => {
      const name = document.getElementById("groupNameInput").value.trim();
      const file = document.getElementById("groupIconUpload").files[0];
      if (!name) return alert("Name required");
      let url = ""; if (file) url = await uploadToCloudinary(file);
      const ref = await db.collection("groups").add({
        name: name, photoUrl: url, admin: currentUser.id, members: [currentUser.id],
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      closeModal("createGroupModal");
      openChat({ id: ref.id, name: name, photoUrl: url, admin: currentUser.id, members: [currentUser.id] }, 'group');
    };
    function showContextForCreateGroup(e, item) {
      const menu = document.getElementById("userContextMenu");
      const x = e.clientX || (e.touches && e.touches[0].clientX); const y = e.clientY || (e.touches && e.touches[0].clientY);
      menu.style.left = `${x}px`; menu.style.top = `${y}px`; menu.classList.add("active");
      document.getElementById("ctxCreateGroup").onclick = () => { menu.classList.remove("active"); openCreateGroupModal(); };
    }

    // --- BASIC UTILS ---
    function backToFriends() {
      localStorage.removeItem("activeChat");
      document.getElementById("chat").classList.remove("show-chat");
      document.getElementById("chat").classList.add("show-users");
      if (unsubscribeMsgs) unsubscribeMsgs();
      if (unsubscribeTyping) unsubscribeTyping();
      currentChatEntity = null;
      document.getElementById("chatMenuDropdown").classList.remove("active");
    }
    function toggleChatMenu() { document.getElementById("chatMenuDropdown").classList.toggle("active"); }
    function showFriendProfile() {
      if (currentChatType === 'group') return;
      document.getElementById("friendProfileModal").classList.add("active");
      document.getElementById("friendModalName").textContent = toTitleCase(currentChatEntity.username);
      const av = document.getElementById("friendModalAvatar");
      av.innerHTML = currentChatEntity.photoUrl ? `<img src="${currentChatEntity.photoUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` : `<div style="width:100%;height:100%;border-radius:50%;background:#eee;display:flex;align-items:center;justify-content:center;font-size:40px;">üë§</div>`;
    }
    function handleFileSelect() { toggleSendBtn(); document.getElementById("filePreviewName").textContent = document.getElementById("fileInput").files[0].name; }
    function toggleSendBtn() {
      const v = document.getElementById("msgInput").value.trim() || document.getElementById("fileInput").files.length > 0;
      document.getElementById("sendBtn").style.display = v ? "flex" : "none";
      document.getElementById("likeBtn").style.display = v ? "none" : "flex";
    }
    function handleInput() { toggleSendBtn(); }
    
    // TYPING INDICATOR (DIRECT ONLY)
    function setupTypingListener() {
        if(currentChatType !== 'direct') return;
        const chatId = [currentUser.id, currentChatEntity.id].sort().join("_");
        // Simple typing logic using a subcollection or metadata. 
        // For this demo, let's skip complex typing sync to keep it stable.
        // If you want typing back, let me know!
    }

    async function uploadToCloudinary(file) {
      const form = new FormData(); form.append("file", file); form.append("upload_preset", CLOUDINARY_PRESET);
      const res = await fetch(CLOUDINARY_URL, { method: "POST", body: form });
      return (await res.json()).secure_url;
    }
    window.onclick = (e) => {
      if (e.target.classList.contains('modal-overlay')) e.target.classList.remove("active");
      if (!e.target.closest('.chat-options-container')) document.getElementById("chatMenuDropdown").classList.remove("active");
      if (!e.target.closest('.user-item') && !e.target.closest('.context-menu')) document.getElementById("userContextMenu").classList.remove("active");
    };
    function toggleSearch() {
      const bar = document.getElementById("chatSearchBar");
      if (!bar.classList.contains("active")) { bar.classList.add("active"); document.getElementById("messageSearchInput").focus(); } else { closeSearch(); }
    }
    function closeSearch() { document.getElementById("chatSearchBar").classList.remove("active"); document.getElementById("messageSearchInput").value = ""; filterMessages(); }
    function filterMessages() {
      const term = document.getElementById("messageSearchInput").value.toLowerCase();
      document.querySelectorAll(".msg-bubble").forEach(b => {
        const row = b.closest(".msg-row");
        if (term === "") row.classList.remove("hidden-by-search");
        else row.classList.toggle("hidden-by-search", !b.textContent.toLowerCase().includes(term));
      });
    }
    async function deleteConversation() {
      if (!confirm("Delete all?")) return;
      const ref = db.collection("chats").doc([currentUser.id, currentChatEntity.id].sort().join("_")).collection("msgs");
      const snap = await ref.get(); const batch = db.batch();
      snap.docs.forEach(d => batch.delete(d.ref)); await batch.commit(); alert("Deleted.");
    }
  </script>
</body>

</html>