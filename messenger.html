<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Bangla Messenger</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    /* ======================
        üé® VARIABLES & RESET
    ====================== */
    :root {
      --primary-gradient: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%);
      --text-dark: #2d3436;
      --text-grey: #636e72;
      --bg-color: #fff0f5;
      --shadow-soft: 0 15px 35px rgba(255, 118, 142, 0.15);
      --glass-border: 1px solid rgba(255, 255, 255, 0.6);
    }

    * {
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    body,
    html {
      margin: 0;
      padding: 0;
      height: 100dvh;
      width: 100%;
      background: var(--bg-color);
      background-image:
        radial-gradient(at 0% 0%, hsla(340, 100%, 76%, 0.2) 0px, transparent 50%),
        radial-gradient(at 100% 100%, hsla(320, 100%, 89%, 0.3) 0px, transparent 50%);
      background-size: cover;
      color: var(--text-dark);
      overflow: hidden;
    }

    /* ======================
        üß© COMPONENTS
    ====================== */
    button {
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(255, 117, 140, 0.25);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      letter-spacing: 0.5px;
    }

    button:active {
      transform: scale(0.96);
    }

    button.secondary-btn {
      background: white;
      color: #ff758c;
      border: 2px solid #ff758c;
      box-shadow: none;
    }

    button.danger-btn {
      background: #ff4757;
      color: white;
      box-shadow: 0 4px 10px rgba(255, 71, 87, 0.3);
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 16px 20px;
      border-radius: 20px;
      border: 1px solid #eee;
      background: #f8f9fa;
      font-size: 15px;
      color: var(--text-dark);
      margin-bottom: 15px;
      outline: none;
      transition: all 0.2s;
    }

    input:focus {
      border-color: #ff758c;
      background: white;
      box-shadow: 0 0 0 4px rgba(255, 117, 140, 0.1);
    }

    /* Glass Modal Overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(12px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.active {
      display: flex !important;
      opacity: 1;
    }

    .box {
      background: rgba(255, 255, 255, 0.95);
      padding: 35px 30px;
      width: 90%;
      max-width: 380px;
      border-radius: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
      text-align: center;
      position: relative;
      border: var(--glass-border);
    }

    .box.animate-zoom {
      animation: zoomIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 28px;
      color: #ccc;
      cursor: pointer;
      line-height: 1;
    }

    .close-btn:hover {
      color: #ff758c;
    }

    /* ======================
        üè† HOME SCREEN
    ====================== */
    #home {
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      position: relative;
    }

    .home-card {
      background: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(20px);
      padding: 50px 30px;
      border-radius: 40px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.05);
      text-align: center;
      max-width: 360px;
      width: 100%;
      border: 1px solid rgba(255, 255, 255, 0.8);
      animation: fadeInUp 0.8s ease-out;
    }

    .home-logo {
      font-size: 70px;
      margin-bottom: 15px;
      display: inline-block;
      animation: float 6s ease-in-out infinite;
    }

    #home h1 {
      font-size: 1.8rem;
      margin-bottom: 10px;
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }

    #home p {
      color: var(--text-grey);
      font-size: 15px;
      margin-bottom: 35px;
      line-height: 1.5;
    }

    /* === NEW: Footer Text Style === */
    .footer-text {
      position: absolute;
      bottom: 20px;
      font-size: 18px;
      color: #888;
      font-weight: 500;
      text-align: center;
      width: 100%;
      opacity: 0.8;
      letter-spacing: 0.5px;
    }
    
    .footer-text span {
        color: #ff758c;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes zoomIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }

    /* ======================
        üë§ PROFILE PAGE
    ====================== */
    #profile {
      height: 100%;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .profile-card {
      background: rgba(255, 255, 255, 0.9);
      padding: 45px 30px;
      border-radius: 35px;
      box-shadow: var(--shadow-soft);
      width: 90%;
      max-width: 350px;
      position: relative;
      border: var(--glass-border);
    }

    .avatar {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      margin: 0 auto 15px;
      padding: 4px;
      background: var(--primary-gradient);
    }

    .avatar img,
    .avatar div {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid white;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 45px;
    }

    .profile-name-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 5px;
    }

    .profile-name-container h2 {
      margin: 0;
      font-size: 24px;
      color: var(--text-dark);
    }

    .edit-icon-btn {
      background: none;
      box-shadow: none;
      color: #ff758c;
      padding: 5px;
      font-size: 20px;
      width: auto;
      border-radius: 50%;
      display: flex;
      align-items: center;
    }

    .edit-icon-btn:hover {
      color: #ff758c;
      background: #fff0f5;
    }

    .status-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-bottom: 30px;
      font-size: 14px;
      color: #888;
    }

    .green-dot {
      width: 10px;
      height: 10px;
      background-color: #2ecc71;
      border-radius: 50%;
      box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2);
    }

    .logout-btn-circle {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #ffe0e6;
      color: #ff4757;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: all 0.2s;
    }

    .logout-btn-circle:hover {
      background: #ff4757;
      color: white;
    }

    /* ======================
        üí¨ CHAT INTERFACE
    ====================== */
    #chat {
      display: none;
      height: 100dvh;
      width: 100%;
      background: #fff;
      overflow: hidden;
      flex-direction: column;
    }

    /* --- Sidebar (Friends List) --- */
    .users {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: #fff;
    }

    .users-header {
      padding: 18px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 201, 243, 0.737);
      backdrop-filter: blur(10px);
      z-index: 2;
      border-bottom: 1px solid rgba(0, 0, 0, 0.03);
    }

    .users-header h2 {
      font-size: 24px;
      color: #ff4757;
      margin: 0;
      font-weight: 700;
    }

    .friend-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px 0;
    }

    .user-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid #f9f9f9;
    }

    .user-item:hover {
      background: #fff5f7;
    }

    .user-info-group {
      display: flex;
      align-items: center;
      flex: 1;
    }

    .user-item img,
    .user-item .placeholder {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 15px;
      background: #eee;
      flex-shrink: 0;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }

    .user-item .placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .user-item span {
      font-weight: 600;
      font-size: 16px;
      color: #333;
    }

    .user-options-btn {
      background: none;
      box-shadow: none;
      padding: 5px;
      color: #b2bec3;
      font-size: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 35px;
      height: 35px;
    }

    .user-options-btn:hover {
      background: #f0f0f0;
      color: #ff4757;
    }

    /* --- Chatbox --- */
    .chatbox {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
      background: #fff;
    }

    .chat-header {
      height: 70px;
      padding: 0 15px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(15px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
      z-index: 10;
      position: relative;
    }

    .back-btn {
      background: none;
      border: none;
      padding: 0;
      color: #ff758c;
      font-size: 26px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      box-shadow: none;
    }

    .chat-avatar {
      width: 44px;
      height: 44px;
      flex-shrink: 0;
      border-radius: 50%;
      overflow: hidden;
    }

    .chat-avatar img,
    .chat-avatar div {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .chat-avatar div {
      background: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-info h3 {
      margin: 0;
      font-size: 17px;
      font-weight: 600;
      line-height: 1.2;
    }

    .chat-info span {
      font-size: 12px;
      color: #888;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .chat-info .active-dot {
      width: 6px;
      height: 6px;
      background: #2ecc71;
      border-radius: 50%;
      display: inline-block;
    }

    .chat-options-container {
      margin-left: auto;
      position: relative;
    }

    .chat-menu-btn {
      background: none;
      box-shadow: none;
      border: none;
      font-size: 24px;
      color: #ff758c;
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Refined Dropdown Style */
    .chat-dropdown {
      position: absolute;
      top: 50px;
      right: 0;
      width: 240px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 100;
      border: 1px solid rgba(0,0,0,0.06);
      padding-top: 5px;
      animation: fadeInMenu 0.2s ease-out forwards;
    }
    
    @keyframes fadeInMenu {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .chat-dropdown.active {
      display: flex;
    }

    .dropdown-item {
      padding: 12px 20px;
      font-size: 14px;
      color: #444;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-weight: 500;
      box-shadow: none;
    }

    .dropdown-item:hover {
      background: #fff0f5;
      color: #ff758c;
    }

    .dropdown-item.danger {
      color: #ff4757;
    }

    .dropdown-item.danger:hover {
      background: #ffe0e6;
    }

    /* Refined E2EE Badge */
    .encrypted-badge {
      font-size: 11px;
      color: #27ae60;
      background: #f0fff4;
      padding: 10px;
      text-align: center;
      cursor: default;
      border-top: 1px solid #eee;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-top: 5px;
    }

    .chat-search-bar {
      display: none;
      padding: 10px 15px;
      background: white;
      border-bottom: 1px solid #eee;
      animation: slideDown 0.2s ease-out;
      flex-shrink: 0;
      position: relative;
    }

    .chat-search-bar.active {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chat-search-bar input {
      flex: 1;
      padding: 8px 15px;
      border-radius: 20px;
      border: 1px solid #ddd;
      font-size: 14px;
      outline: none;
      background: #f5f5f5;
      margin: 0;
    }

    .close-search-btn {
      background: none;
      border: none;
      color: #ff4757;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      box-shadow: none;
      transition: all 0.2s;
    }
    

    @keyframes slideDown {
      from { transform: translateY(-10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* --- MESSAGES AREA --- */
    .messages {
      flex: 1;
      padding: 15px 15px 5px 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
      background-color: #efe7dd;
      background-image: url("https://www.transparenttextures.com/patterns/cubes.png");
      background-blend-mode: overlay;
      background: linear-gradient(rgba(255, 240, 245, 0.9), rgba(255, 240, 245, 0.9)), url("https://www.transparenttextures.com/patterns/cubes.png");
    }

    .date-separator {
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: #888;
      margin: 20px 0 10px;
      text-transform: uppercase;
      background: rgba(255, 255, 255, 0.7);
      padding: 4px 12px;
      border-radius: 12px;
      align-self: center;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .msg-row {
      display: flex;
      align-items: center;
      gap: 5px;
      max-width: 80%;
      position: relative;
      margin-bottom: 2px;
    }

    .msg-row.hidden-by-search {
      display: none !important;
    }

    .msg-row.me {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .msg-row.other {
      align-self: flex-start;
    }

    .msg-bubble {
      padding: 12px 18px;
      font-size: 15px;
      line-height: 1.4;
      position: relative;
      word-wrap: break-word;
      box-shadow: 0 1px 1px rgba(0, 0, 0, 0.08);
      border-radius: 20px;
    }

    .msg-row.me .msg-bubble {
      background: var(--primary-gradient);
      color: white;
      border-bottom-right-radius: 4px;
      box-shadow: 0 4px 15px rgba(255, 117, 140, 0.2);
    }

    .msg-row.other .msg-bubble {
      background: white;
      color: var(--text-dark);
      border-bottom-left-radius: 4px;
    }

    .msg-bubble img {
      border-radius: 12px;
      margin-top: 5px;
      max-width: 100%;
      display: block;
    }

    .like-msg {
      font-size: 40px;
      background: none !important;
      box-shadow: none !important;
      padding: 0;
    }

    /* 3-Dots for Message */
    .msg-menu-container {
      position: relative;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .msg-row:hover .msg-menu-container {
      opacity: 1;
    }

    .msg-dots-btn {
      background: none;
      border: none;
      font-size: 18px;
      color: #999;
      cursor: pointer;
      padding: 0 5px;
      box-shadow: none;
    }

    .msg-delete-popup {
      position: absolute;
      top: 20px;
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      display: none;
      z-index: 20;
      font-size: 12px;
      color: #ff4757;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }

    .msg-row.me .msg-delete-popup {
      right: 0;
    }

    .msg-row.other .msg-delete-popup {
      left: 0;
    }

    /* Input Bar */
    .input-bar {
      min-height: 70px;
      padding: 10px 15px;
      background: white;
      display: flex;
      align-items: center;
      gap: 10px;
      border-top: 1px solid rgba(0, 0, 0, 0.05);
      flex-shrink: 0;
    }

    .icon-btn {
      background: none;
      border: none;
      width: 44px;
      height: 44px;
      font-size: 24px;
      cursor: pointer;
      color: #ff758c;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: none;
      flex-shrink: 0;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .icon-btn:hover {
      background: #fff0f5;
    }

    .input-wrapper {
      flex: 1;
      background: #f0f2f5;
      border-radius: 24px;
      display: flex;
      align-items: center;
      padding: 0 15px;
      height: 46px;
      transition: background 0.2s;
    }

    .input-wrapper:focus-within {
      background: #fff0f5;
    }

    .input-wrapper input {
      width: 100%;
      background: transparent;
      border: none;
      padding: 0;
      margin: 0;
      font-size: 16px;
      color: var(--text-dark);
      height: 100%;
    }

    .input-wrapper input:focus {
      box-shadow: none;
      border: none;
    }

    #sendBtn,
    #likeBtn {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      flex-shrink: 0;
      box-shadow: none;
    }

    #likeBtn {
      background: transparent;
      font-size: 32px;
    }

    #sendBtn {
      background: var(--primary-gradient);
      color: white;
      font-size: 18px;
      display: none;
      box-shadow: 0 4px 12px rgba(255, 117, 140, 0.4);
    }

    .hidden {
      display: none !important;
    }

    #fileInput {
      display: none;
    }

    .show-users .users {
      display: flex;
    }

    .show-users .chatbox {
      display: none;
    }

    .show-chat .users {
      display: none;
    }

    .show-chat .chatbox {
      display: flex;
    }

    #filePreviewName {
      font-size: 10px;
      color: #ff758c;
      font-weight: 600;
      max-width: 60px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .login-head{
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 30px;
    }

  </style>
</head>

<body>

  <div id="home">
    <div class="home-card">
      <div class="home-logo">üå∏</div>
      <h1>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Æ‡ßá‡¶∏‡ßá‡¶û‡ßç‡¶ú‡¶æ‡¶∞</h1>
      <p>Connect with your friends in a simple & aesthetic way.</p>
      <button id="startBtn">Get Started</button>
    </div>
    
    <div class="footer-text">Made with ‚ù§Ô∏è by <span>Nafis</span></div>
  </div>

  <div id="loginModal" class="modal-overlay" style="display: none;">
    <div class="box">
      <span class="close-btn" onclick="closeLoginAndShowHome()">&times;</span>
      <h2 class="login-head">‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá üíñ</h2>
      <p style="color:#888; margin-bottom: 20px;">Login or Sign up to Join the chat</p>
      <input id="username" type="text" placeholder="Username" />
      <input id="password" type="password" placeholder="Password" />
      <button id="loginBtn" style="width:100%">Continue</button>
    </div>
  </div>

  <div id="profile" style="display: none;">
    <div class="profile-card">
      <button id="logoutBtn" class="logout-btn-circle" title="Logout">‚õî</button>

      <div class="avatar" id="myAvatarDisplay">
        <div>üë§</div>
      </div>

      <div class="profile-name-container">
        <h2 id="profileNameDisplay">User</h2>
        <button id="openEditProfileBtn" class="edit-icon-btn" title="Edit Profile">‚úé</button>
      </div>

      <div class="status-container">
        <div class="green-dot"></div>
        <span>Online</span>
      </div>

      <div style="display:flex; flex-direction:column; gap:12px;">
        <button id="addFriendBtn" class="secondary-btn">Add Friend</button>
        <button id="goToChatsBtn">Go to Chats üí¨</button>
      </div>
    </div>
  </div>

  <div id="editProfileModal" class="modal-overlay" style="display: none;">
    <div class="box">
      <span class="close-btn" onclick="closeModal('editProfileModal')">&times;</span>
      <h3>Update Profile</h3>
      <input type="text" id="newUsernameInput" placeholder="New Username" />
      <input type="text" id="newPhotoUrlInput" placeholder="Profile Image URL" />
      <p style="font-size:13px; color:#aaa; margin:10px 0;">OR Upload Image</p>
      <input type="file" id="profilePicUpload" style="font-size:14px;" />
      <button id="saveProfileBtn" style="margin-top:20px; width:100%;">Save Changes</button>
    </div>
  </div>

  <div id="addFriendModal" class="modal-overlay" style="display: none;">
    <div class="box">
      <span class="close-btn" onclick="closeModal('addFriendModal')">&times;</span>
      <h3>Add Friend</h3>
      <p style="color:#888; font-size:14px; margin-bottom:15px;">Search by username</p>
      <input type="text" id="friendUsernameInput" placeholder="Exact Username" />
      <button id="searchFriendBtn" style="width:100%;">Add User</button>
    </div>
  </div>

  <div id="deleteChatModal" class="modal-overlay" style="display: none;">
    <div class="box">
      <span class="close-btn" onclick="closeModal('deleteChatModal')">&times;</span>
      <h3 style="color:#ff4757;">Remove Friend?</h3>
      <p style="color:#666; font-size:14px; margin-bottom:20px;">
        This will remove <b id="deleteTargetName">User</b> from your chat list.
      </p>
      <button id="confirmDeleteBtn" class="danger-btn" style="width:100%;">Yes, Remove</button>
    </div>
  </div>

  <div id="friendProfileModal" class="modal-overlay" style="display: none;">
    <div class="box">
      <span class="close-btn" onclick="closeModal('friendProfileModal')">&times;</span>
      <div class="avatar" id="friendModalAvatar" style="width:100px; height:100px; margin-bottom:15px;"></div>
      <h3 id="friendModalName" style="margin-bottom:5px;">User</h3>
      <p style="color:#aaa; font-size:14px;">Bangla Messenger User</p>
    </div>
  </div>

  <div id="chat" class="show-users" style="display: none;">

    <div class="users">
      <div class="users-header">
        <h2>Chats</h2>
        <button onclick="goToProfile()" class="secondary-btn"
          style="padding: 8px 16px; font-size:12px;">Profile</button>
      </div>
      <div id="friendsListContainer" class="friend-list"></div>
    </div>

    <div class="chatbox">
      <div class="chat-header">
        <button class="back-btn" onclick="backToFriends()">‚Üê</button>
        <div class="chat-avatar" id="chatHeaderIcon" onclick="showFriendProfile()"></div>
        <div class="chat-info">
          <h3 id="chatHeaderName">User</h3>
          <span><span class="active-dot"></span> Active now</span>
        </div>

        <div class="chat-options-container">
            <button class="chat-menu-btn" onclick="toggleChatMenu()">‚ãÆ</button>
            <div class="chat-dropdown" id="chatMenuDropdown">
                <button class="dropdown-item" onclick="showFriendProfile(); toggleChatMenu()">
                   üë§ View Profile
                </button>
                <button class="dropdown-item" onclick="toggleSearch(); toggleChatMenu()">
                   üîç Search
                </button>
                <button class="dropdown-item" onclick="alert('Privacy Policy: Your messages are stored securely in Firebase.'); toggleChatMenu()">
                    üõ° Privacy
                </button>
                <button class="dropdown-item" onclick="alert('Support: Contact Nafis for help.'); toggleChatMenu()">
                    ‚ùì Support
                </button>
                <button class="dropdown-item danger" onclick="deleteConversation(); toggleChatMenu()">
                    üóë Delete Chat
                </button>
                <div class="encrypted-badge">üîí End-to-end Encrypted</div>
            </div>
        </div>
      </div>

      <div class="chat-search-bar" id="chatSearchBar">
        <input type="text" id="messageSearchInput" placeholder="Search..." oninput="filterMessages()" />
        <button class="close-search-btn" onclick="closeSearch()" title="Close Search">‚úñ</button>
      </div>

      <div class="messages" id="messages"></div>

      <div class="input-bar">
        <input type="file" id="fileInput" onchange="handleFileSelect()" />
        <label for="fileInput" class="icon-btn" title="Send File">üìé</label>

        <span id="filePreviewName"></span>

        <div class="input-wrapper">
          <input id="msgInput" type="text" placeholder="Type a message..." autocomplete="off"
            oninput="toggleSendBtn()" />
        </div>

        <button id="likeBtn" class="icon-btn" onclick="sendLike()">üëç</button>
        <button id="sendBtn" onclick="sendMessage()">‚û§</button>
      </div>
    </div>
  </div>

  <script>
    firebase.initializeApp({
      apiKey: "AIzaSyDEdvwTvt-tSuWt5cJN5vInxWhm5gCuefo",
      authDomain: "cryptchat-web.firebaseapp.com",
      projectId: "cryptchat-web"
    });
    const db = firebase.firestore();
    const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dpv173a1d/auto/upload";
    const CLOUDINARY_PRESET = "unsigned_preset";

    let currentUser = null;
    let currentChatFriend = null;
    let unsubscribeMsgs = null;
    let unsubscribeFriends = null;
    let friendToDelete = null;

    window.addEventListener("DOMContentLoaded", () => {
      const storedId = localStorage.getItem("uid");
      if (storedId) fetchUser(storedId);
      else document.getElementById("home").style.display = "flex";

      const loginAction = () => document.getElementById("loginBtn").click();
      document.getElementById("username").addEventListener("keydown", (e) => { if(e.key === "Enter") loginAction(); });
      document.getElementById("password").addEventListener("keydown", (e) => { if(e.key === "Enter") loginAction(); });
    });

    document.getElementById("startBtn").onclick = () => {
      const modal = document.getElementById("loginModal");
      modal.classList.add("active");
      const box = modal.querySelector('.box');
      box.classList.remove('animate-zoom');
      void box.offsetWidth; 
      box.classList.add('animate-zoom');
    };

    function closeLoginAndShowHome() {
      document.getElementById("loginModal").classList.remove("active");
      document.getElementById("home").style.display = "flex";
      document.getElementById("profile").style.display = "none";
      document.getElementById("chat").style.display = "none";
    }

    async function fetchUser(uid) {
      try {
        const doc = await db.collection("users").doc(uid).get();
        if (doc.exists) {
          currentUser = { id: doc.id, ...doc.data() };
          localStorage.setItem("uid", uid);

          document.getElementById("loginModal").classList.remove("active");
          document.getElementById("home").style.display = "none";

          const activeChat = localStorage.getItem("activeChat");
          if (activeChat) {
            const friend = JSON.parse(activeChat);
            showChatInbox(); 
            setupRealTimeFriendList(); 
            openChat(friend); 
          } else {
            showChatInbox(); 
          }

        } else {
          localStorage.clear();
          location.reload();
        }
      } catch (e) { console.error(e); }
    }

    function showChatInbox() {
      document.getElementById("home").style.display = "none";
      document.getElementById("profile").style.display = "none";
      document.getElementById("chat").style.display = "flex";
      backToFriends();
      setupRealTimeFriendList();
    }

    document.getElementById("loginBtn").onclick = async () => {
      const u = document.getElementById("username").value.trim().toLowerCase();
      const p = document.getElementById("password").value;
      if (!u || !p) return alert("Please fill all fields");

      const snap = await db.collection("users").where("username", "==", u).get();
      if (!snap.empty) {
        const doc = snap.docs[0];
        if (doc.data().password === p) {
          fetchUser(doc.id);
        } else {
          alert("Incorrect password");
        }
      } else {
        const ref = await db.collection("users").add({
          username: u, password: p, photoUrl: "", friends: [],
          created: firebase.firestore.FieldValue.serverTimestamp()
        });
        fetchUser(ref.id);
      }
    };

    // === UPDATED: Logout with Confirmation ===
    document.getElementById("logoutBtn").onclick = () => {
      if(!confirm("Are you sure you want to log out?")) return; // Confirmation Alert

      localStorage.clear();
      currentUser = null;
      currentChatFriend = null;

      document.getElementById("profile").style.display = "none";
      document.getElementById("chat").style.display = "none";
      document.getElementById("home").style.display = "none";

      const modal = document.getElementById("loginModal");
      modal.classList.add("active");
      const box = modal.querySelector('.box');
      box.classList.remove('animate-zoom');
      void box.offsetWidth;
      box.classList.add('animate-zoom');

      document.getElementById("username").value = "";
      document.getElementById("password").value = "";
    };

    function showProfilePage() {
      document.getElementById("profile").style.display = "flex";
      document.getElementById("chat").style.display = "none";
      document.getElementById("home").style.display = "none";

      document.getElementById("profileNameDisplay").textContent = formatName(currentUser.username);
      const avatarDiv = document.getElementById("myAvatarDisplay");
      if (currentUser.photoUrl) avatarDiv.innerHTML = `<img src="${currentUser.photoUrl}" />`;
      else avatarDiv.innerHTML = `<div>üë§</div>`;
    }

    document.getElementById("openEditProfileBtn").onclick = () => {
      const modal = document.getElementById("editProfileModal");
      modal.classList.add("active");
      modal.querySelector('.box').classList.add('animate-zoom');
      document.getElementById("newUsernameInput").value = currentUser.username;
      document.getElementById("newPhotoUrlInput").value = currentUser.photoUrl || "";
    };

    document.getElementById("saveProfileBtn").onclick = async () => {
      const newName = document.getElementById("newUsernameInput").value.trim().toLowerCase();
      let newUrl = document.getElementById("newPhotoUrlInput").value.trim();
      const file = document.getElementById("profilePicUpload").files[0];

      if (file) newUrl = await uploadToCloudinary(file);

      if (newName !== currentUser.username) {
        const check = await db.collection("users").where("username", "==", newName).get();
        if (!check.empty) return alert("Username taken!");
      }

      await db.collection("users").doc(currentUser.id).update({ username: newName, photoUrl: newUrl });
      currentUser.username = newName;
      currentUser.photoUrl = newUrl;
      closeModal('editProfileModal');
      showProfilePage();
    };

    document.getElementById("addFriendBtn").onclick = () => {
      const modal = document.getElementById("addFriendModal");
      modal.classList.add("active");
      modal.querySelector('.box').classList.add('animate-zoom');
    };

    document.getElementById("searchFriendBtn").onclick = async () => {
      const targetName = document.getElementById("friendUsernameInput").value.trim().toLowerCase();
      if (targetName === currentUser.username) return alert("Cannot add yourself.");

      const snap = await db.collection("users").where("username", "==", targetName).get();
      if (snap.empty) return alert("User not found.");

      const friendDoc = snap.docs[0];
      const friendId = friendDoc.id;
      const friendData = friendDoc.data();

      if (!currentUser.friends.includes(friendId)) {
        const myNewFriends = [...currentUser.friends, friendId];
        await db.collection("users").doc(currentUser.id).update({ friends: myNewFriends });
      } else {
        return alert("Already friends!");
      }

      const targetFriends = friendData.friends || [];
      if (!targetFriends.includes(currentUser.id)) {
        const theirNewFriends = [...targetFriends, currentUser.id];
        await db.collection("users").doc(friendId).update({ friends: theirNewFriends });
      }

      alert("Friend added!");
      closeModal('addFriendModal');
      document.getElementById("friendUsernameInput").value = "";
    };

    document.getElementById("goToChatsBtn").onclick = () => {
      showChatInbox();
    };

    function goToProfile() { showProfilePage(); }

    function setupRealTimeFriendList() {
      if (unsubscribeFriends) return;

      const container = document.getElementById("friendsListContainer");

      unsubscribeFriends = db.collection("users").doc(currentUser.id)
        .onSnapshot(async (doc) => {
          const data = doc.data();
          currentUser.friends = data.friends || [];

          if (!currentUser.friends || currentUser.friends.length === 0) {
            container.innerHTML = "<div style='text-align:center;margin-top:40px;color:#888;'>No friends yet.<br>Click 'Profile' to add some!</div>";
            return;
          }

          container.innerHTML = "";

          for (const fid of currentUser.friends) {
            const fDoc = await db.collection("users").doc(fid).get();
            if (fDoc.exists) {
              const fData = fDoc.data();
              const div = document.createElement("div");
              div.className = "user-item";

              const imgHTML = fData.photoUrl
                ? `<img src="${fData.photoUrl}">`
                : `<div class="placeholder">üë§</div>`;

              const infoDiv = document.createElement("div");
              infoDiv.className = "user-info-group";
              infoDiv.innerHTML = `${imgHTML} <span>${formatName(fData.username)}</span>`;
              infoDiv.onclick = () => openChat({ id: fDoc.id, ...fData });

              const menuBtn = document.createElement("button");
              menuBtn.className = "user-options-btn";
              menuBtn.innerHTML = "‚ãÆ";
              menuBtn.onclick = (e) => {
                e.stopPropagation();
                showDeleteModal(fDoc.id, fData.username);
              };

              div.appendChild(infoDiv);
              div.appendChild(menuBtn);
              container.appendChild(div);
            }
          }
        });
    }

    function showDeleteModal(fid, fname) {
      friendToDelete = fid;
      document.getElementById("deleteTargetName").textContent = formatName(fname);
      const modal = document.getElementById("deleteChatModal");
      modal.classList.add("active");
      modal.querySelector('.box').classList.add('animate-zoom');
    }

    document.getElementById("confirmDeleteBtn").onclick = async () => {
      if (!friendToDelete) return;
      const newFriends = currentUser.friends.filter(id => id !== friendToDelete);
      await db.collection("users").doc(currentUser.id).update({ friends: newFriends });
      closeModal("deleteChatModal");
    };

    function openChat(friend) {
      currentChatFriend = friend;
      localStorage.setItem("activeChat", JSON.stringify(friend));

      const chatDiv = document.getElementById("chat");
      chatDiv.classList.remove("show-users");
      chatDiv.classList.add("show-chat");

      document.getElementById("chatHeaderName").textContent = formatName(friend.username);
      const iconDiv = document.getElementById("chatHeaderIcon");
      if (friend.photoUrl) iconDiv.innerHTML = `<img src="${friend.photoUrl}">`;
      else iconDiv.innerHTML = `<div>üë§</div>`;

      // Reset search
      document.getElementById("chatSearchBar").classList.remove("active");
      document.getElementById("messageSearchInput").value = "";

      loadMessages();
    }

    function backToFriends() {
      localStorage.removeItem("activeChat");
      const chatDiv = document.getElementById("chat");
      chatDiv.classList.remove("show-chat");
      chatDiv.classList.add("show-users");
      if (unsubscribeMsgs) unsubscribeMsgs();
      currentChatFriend = null;
      
      document.getElementById("chatMenuDropdown").classList.remove("active");
      document.getElementById("chatSearchBar").classList.remove("active");
    }

    function showFriendProfile() {
      if (!currentChatFriend) return;
      const modal = document.getElementById("friendProfileModal");
      modal.classList.add("active");
      modal.querySelector('.box').classList.add('animate-zoom');
      document.getElementById("friendModalName").textContent = formatName(currentChatFriend.username);
      const av = document.getElementById("friendModalAvatar");
      if (currentChatFriend.photoUrl) av.innerHTML = `<img src="${currentChatFriend.photoUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
      else av.innerHTML = `<div style="width:100%;height:100%;border-radius:50%;background:#eee;display:flex;align-items:center;justify-content:center;font-size:40px;">üë§</div>`;
    }

    function loadMessages() {
      if (unsubscribeMsgs) unsubscribeMsgs();
      const chatId = [currentUser.id, currentChatFriend.id].sort().join("_");
      const msgsDiv = document.getElementById("messages");

      unsubscribeMsgs = db.collection("chats").doc(chatId).collection("msgs")
        .orderBy("time")
        .onSnapshot(snap => {
          msgsDiv.innerHTML = "";
          let lastDate = null;

          snap.forEach(doc => {
            const m = doc.data();
            const msgId = doc.id;
            const date = m.time ? m.time.toDate() : new Date();

            const dateStr = date.toDateString();
            if (dateStr !== lastDate) {
              const sep = document.createElement("div");
              sep.className = "date-separator";
              const isToday = new Date().toDateString() === dateStr;
              sep.textContent = isToday
                ? `${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`
                : `${date.toLocaleDateString()} ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
              msgsDiv.appendChild(sep);
              lastDate = dateStr;
            }

            const rowDiv = document.createElement("div");
            const isMe = m.sender === currentUser.id;
            rowDiv.className = "msg-row " + (isMe ? "me" : "other");

            if (isMe) {
              const menuContainer = document.createElement("div");
              menuContainer.className = "msg-menu-container";
              menuContainer.innerHTML = `
                            <button class="msg-dots-btn">‚ãÆ</button>
                            <div class="msg-delete-popup" onclick="deleteMessage('${chatId}', '${msgId}')">Delete</div>
                        `;
              const btn = menuContainer.querySelector('.msg-dots-btn');
              const popup = menuContainer.querySelector('.msg-delete-popup');
              btn.onclick = () => { popup.style.display = popup.style.display === 'block' ? 'none' : 'block'; };
              rowDiv.appendChild(menuContainer);
            }

            const bubble = document.createElement("div");
            bubble.className = "msg-bubble";

            if (m.type === "text") {
              bubble.textContent = m.content;
            } else if (m.type === "file") {
              if (m.fileType && m.fileType.startsWith("image")) {
                bubble.innerHTML = `<img src="${m.url}">`;
              } else {
                bubble.innerHTML = `<a href="${m.url}" target="_blank" style="color:inherit;text-decoration:underline;">üìÑ File Attachment</a>`;
              }
            } else if (m.type === "like") {
              bubble.className += " like-msg";
              bubble.textContent = "üëç";
            }
            rowDiv.appendChild(bubble);
            msgsDiv.appendChild(rowDiv);
          });
          msgsDiv.scrollTop = msgsDiv.scrollHeight;
          filterMessages();
        });
    }

    async function deleteMessage(chatId, msgId) {
      if (confirm("Delete this message?")) {
        await db.collection("chats").doc(chatId).collection("msgs").doc(msgId).delete();
      }
    }

    async function sendMessage() {
      const input = document.getElementById("msgInput");
      const txt = input.value.trim();
      const file = document.getElementById("fileInput").files[0];

      if (!txt && !file) return;

      const chatId = [currentUser.id, currentChatFriend.id].sort().join("_");

      if (file) {
        const url = await uploadToCloudinary(file);
        await db.collection("chats").doc(chatId).collection("msgs").add({
          sender: currentUser.id, type: "file", url: url, fileType: file.type,
          time: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById("fileInput").value = "";
        document.getElementById("filePreviewName").textContent = "";
      }

      if (txt) {
        await db.collection("chats").doc(chatId).collection("msgs").add({
          sender: currentUser.id, type: "text", content: txt,
          time: firebase.firestore.FieldValue.serverTimestamp()
        });
        input.value = "";
      }
      toggleSendBtn();
    }

    async function sendLike() {
      const chatId = [currentUser.id, currentChatFriend.id].sort().join("_");
      await db.collection("chats").doc(chatId).collection("msgs").add({
        sender: currentUser.id, type: "like",
        time: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    function toggleSendBtn() {
      const txt = document.getElementById("msgInput").value.trim();
      const hasFile = document.getElementById("fileInput").files.length > 0;

      if (txt || hasFile) {
        document.getElementById("sendBtn").style.display = "flex";
        document.getElementById("likeBtn").style.display = "none";
      } else {
        document.getElementById("sendBtn").style.display = "none";
        document.getElementById("likeBtn").style.display = "flex";
      }
    }

    function handleFileSelect() {
      const f = document.getElementById("fileInput").files[0];
      document.getElementById("filePreviewName").textContent = f ? f.name : "";
      toggleSendBtn();
    }

    async function uploadToCloudinary(file) {
      const form = new FormData();
      form.append("file", file);
      form.append("upload_preset", CLOUDINARY_PRESET);
      const res = await fetch(CLOUDINARY_URL, { method: "POST", body: form });
      const data = await res.json();
      return data.secure_url;
    }

    function formatName(name) { return name.charAt(0).toUpperCase() + name.slice(1); }

    function closeModal(id) {
      document.getElementById(id).classList.remove("active");
    }

    document.getElementById("msgInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });

    window.onclick = function (event) {
      if (event.target.classList.contains('modal-overlay')) {
        event.target.classList.remove("active");
      }
      if (!event.target.closest('.chat-options-container')) {
          document.getElementById("chatMenuDropdown").classList.remove("active");
      }
    }

    /* =========================================
       Menu, Search Toggle & Logic
    ========================================= */
    function toggleChatMenu() {
        const drop = document.getElementById("chatMenuDropdown");
        drop.classList.toggle("active");
    }

    function toggleSearch() {
        const bar = document.getElementById("chatSearchBar");
        
        // If hidden, show it
        if(!bar.classList.contains("active")) {
            bar.classList.add("active");
            document.getElementById("messageSearchInput").focus();
        } else {
            // If already shown, close it
            closeSearch();
        }
    }

    function closeSearch() {
        const bar = document.getElementById("chatSearchBar");
        bar.classList.remove("active");
        
        // Clear input and restore messages
        const input = document.getElementById("messageSearchInput");
        input.value = "";
        filterMessages(); // Triggers reset
    }

    function filterMessages() {
        const term = document.getElementById("messageSearchInput").value.toLowerCase();
        const bubbles = document.querySelectorAll(".msg-bubble");
        
        bubbles.forEach(b => {
            const row = b.closest(".msg-row");
            if(term === "") {
                row.classList.remove("hidden-by-search");
                return;
            }
            if(b.textContent.toLowerCase().includes(term)) {
                row.classList.remove("hidden-by-search");
            } else {
                row.classList.add("hidden-by-search");
            }
        });
    }

    async function deleteConversation() {
        if(!confirm("Are you sure you want to delete ALL messages in this chat? This cannot be undone.")) return;
        
        const chatId = [currentUser.id, currentChatFriend.id].sort().join("_");
        const msgsRef = db.collection("chats").doc(chatId).collection("msgs");
        
        try {
            const snapshot = await msgsRef.get();
            const batch = db.batch();
            snapshot.docs.forEach((doc) => {
                batch.delete(doc.ref);
            });
            await batch.commit();
            alert("Chat deleted successfully.");
        } catch(e) {
            console.error(e);
            alert("Error deleting chat.");
        }
    }
  </script>
</body>

</html>