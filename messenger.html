<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Bangla Messenger</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    /* ======================
        üé® VARIABLES (THEMING)
    ====================== */
    :root {
      /* --- LIGHT MODE (Default) --- */
      --primary-gradient: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%);
      --primary-solid: #ff758c;
      
      --bg-body: #fff0f5; /* Light Pinkish Bg */
      --bg-card: rgba(255, 255, 255, 0.9);
      --bg-glass-border: rgba(255, 255, 255, 0.6);
      
      --text-main: #2d3436;
      --text-sec: #636e72;
      
      --chat-header-bg: rgba(255, 255, 255, 0.95);
      --chat-bg-color: #efe7dd; 
      
      --msg-in-bg: #ffffff;
      --msg-in-text: #2d3436;
      --msg-out-text: #ffffff;
      
      --input-bar-bg: #ffffff;
      --input-field-bg: #f0f2f5;
      
      --shadow-soft: 0 15px 35px rgba(255, 118, 142, 0.15);
      
      /* Background Blend for Doodle (Darken for light mode) */
      --doodle-blend: overlay; 
      --doodle-opacity: 0.15; 
    }

    /* --- DARK MODE OVERRIDES --- */
    [data-theme="dark"] {
      --bg-body: #121212; /* Deep Dark */
      --bg-card: rgba(30, 30, 40, 0.9);
      --bg-glass-border: rgba(255, 255, 255, 0.1);
      
      --text-main: #e0e0e0;
      --text-sec: #b0b0b0;
      
      --chat-header-bg: #1f1f1f;
      --chat-bg-color: #0d0d0d;
      
      --msg-in-bg: #2b2b2b;
      --msg-in-text: #ffffff;
      
      --input-bar-bg: #1f1f1f;
      --input-field-bg: #2b2b2b;
      
      --shadow-soft: 0 15px 35px rgba(0, 0, 0, 0.5);
      
      /* Lighter blend for dark mode so doodle shows */
      --doodle-blend: screen; 
      --doodle-opacity: 0.2;
    }

    * {
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    body,
    html {
      margin: 0;
      padding: 0;
      height: 100dvh;
      width: 100%;
      background-color: var(--bg-body);
      color: var(--text-main);
      overflow: hidden;
      transition: background-color 0.3s, color 0.3s;
    }
    
    /* Global Background Pattern for App (Outside Chat) */
    body::before {
        content: "";
        position: absolute;
        width: 100%;
        height: 100%;
        top:0; left:0;
        z-index: -1;
        background-image: 
            radial-gradient(at 0% 0%, hsla(340, 100%, 76%, 0.1) 0px, transparent 50%),
            radial-gradient(at 100% 100%, hsla(320, 100%, 89%, 0.1) 0px, transparent 50%);
    }

    /* ======================
        üß© COMPONENTS
    ====================== */
    button {
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(255, 117, 140, 0.25);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      letter-spacing: 0.5px;
    }

    button:active {
      transform: scale(0.96);
    }

    button.secondary-btn {
      background: transparent;
      color: var(--primary-solid);
      border: 2px solid var(--primary-solid);
      box-shadow: none;
    }

    button.danger-btn {
      background: #ff4757;
      color: white;
      box-shadow: 0 4px 10px rgba(255, 71, 87, 0.3);
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 16px 20px;
      border-radius: 20px;
      border: 1px solid var(--bg-glass-border);
      background: var(--input-field-bg);
      font-size: 15px;
      color: var(--text-main);
      margin-bottom: 15px;
      outline: none;
      transition: all 0.2s;
    }

    input:focus {
      border-color: var(--primary-solid);
      box-shadow: 0 0 0 4px rgba(255, 117, 140, 0.1);
    }

    /* Glass Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(12px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.active {
      display: flex !important;
      opacity: 1;
    }

    .box {
      background: var(--bg-card);
      padding: 35px 30px;
      width: 90%;
      max-width: 380px;
      border-radius: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
      text-align: center;
      position: relative;
      border: 1px solid var(--bg-glass-border);
      color: var(--text-main);
    }

    .box.animate-zoom {
      animation: zoomIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 28px;
      color: var(--text-sec);
      cursor: pointer;
      line-height: 1;
    }

    .close-btn:hover {
      color: var(--primary-solid);
    }

    /* ======================
        üè† HOME SCREEN
    ====================== */
    #home {
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      position: relative;
    }

    .home-card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      padding: 50px 30px;
      border-radius: 40px;
      box-shadow: var(--shadow-soft);
      text-align: center;
      max-width: 360px;
      width: 100%;
      border: 1px solid var(--bg-glass-border);
      animation: fadeInUp 0.8s ease-out;
    }

    .home-logo {
      font-size: 70px;
      margin-bottom: 15px;
      display: inline-block;
      animation: float 6s ease-in-out infinite;
    }

    #home h1 {
      font-size: 1.8rem;
      margin-bottom: 10px;
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }

    #home p {
      color: var(--text-sec);
      font-size: 15px;
      margin-bottom: 35px;
      line-height: 1.5;
    }

    .footer-text {
      position: absolute;
      bottom: 20px;
      font-size: 16px;
      color: var(--text-sec);
      font-weight: 500;
      text-align: center;
      width: 100%;
      opacity: 0.8;
    }
    
    .footer-text span {
        color: var(--primary-solid);
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes zoomIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }

    /* ======================
        üë§ PROFILE PAGE
    ====================== */
    #profile {
      height: 100%;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .profile-card {
      background: var(--bg-card);
      padding: 45px 30px;
      border-radius: 35px;
      box-shadow: var(--shadow-soft);
      width: 90%;
      max-width: 350px;
      position: relative;
      border: 1px solid var(--bg-glass-border);
    }

    .avatar {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      margin: 0 auto 15px;
      padding: 4px;
      background: var(--primary-gradient);
    }

    .avatar img,
    .avatar div {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--bg-card);
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 45px;
    }

    .profile-name-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 5px;
    }

    .profile-name-container h2 {
      margin: 0;
      font-size: 24px;
      color: var(--text-main);
    }

    .edit-icon-btn {
      background: none;
      box-shadow: none;
      color: var(--primary-solid);
      padding: 5px;
      font-size: 20px;
      width: auto;
      border-radius: 50%;
      display: flex;
      align-items: center;
    }

    .status-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-bottom: 30px;
      font-size: 14px;
      color: var(--text-sec);
    }

    .green-dot {
      width: 10px;
      height: 10px;
      background-color: #2ecc71;
      border-radius: 50%;
      box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2);
    }

    .logout-btn-circle {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 71, 87, 0.1);
      color: #ff4757;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: all 0.2s;
    }

    .logout-btn-circle:hover {
      background: #ff4757;
      color: white;
    }

    /* ======================
        üí¨ CHAT INTERFACE
    ====================== */
    #chat {
      display: none;
      height: 100dvh;
      width: 100%;
      background: var(--bg-body);
      overflow: hidden;
      flex-direction: column;
    }

    /* --- Sidebar (Friends List) --- */
    .users {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: var(--bg-card);
    }

    .users-header {
      padding: 18px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--chat-header-bg);
      backdrop-filter: blur(10px);
      z-index: 2;
      border-bottom: 1px solid var(--bg-glass-border);
    }

    .users-header h2 {
      font-size: 24px;
      color: var(--primary-solid);
      margin: 0;
      font-weight: 700;
    }
    
    .users-header .secondary-btn {
        padding: 6px 14px; 
        font-size:12px;
        background: transparent;
        color: var(--primary-solid);
        border: 1px solid var(--primary-solid);
    }

    .friend-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px 0;
    }

    .user-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid var(--bg-glass-border);
    }

    .user-item:hover {
      background: rgba(255, 117, 140, 0.05);
    }

    .user-info-group {
      display: flex;
      align-items: center;
      flex: 1;
    }

    .user-item img,
    .user-item .placeholder {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 15px;
      background: #eee;
      flex-shrink: 0;
    }

    .user-item .placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .user-item span {
      font-weight: 600;
      font-size: 16px;
      color: var(--text-main);
    }

    .user-options-btn {
      background: none;
      box-shadow: none;
      padding: 5px;
      color: var(--text-sec);
      font-size: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 35px;
      height: 35px;
    }

    /* --- Chatbox --- */
    .chatbox {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
      background: var(--bg-body);
      position: relative; 
    }

    .chat-header {
      height: 70px;
      padding: 0 15px;
      background: var(--chat-header-bg);
      backdrop-filter: blur(15px);
      border-bottom: 1px solid var(--bg-glass-border);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
      z-index: 10;
      position: relative;
    }

    .back-btn {
      background: none;
      border: none;
      padding: 0;
      color: var(--primary-solid);
      font-size: 26px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      box-shadow: none;
    }

    .chat-avatar {
      width: 44px;
      height: 44px;
      flex-shrink: 0;
      border-radius: 50%;
      overflow: hidden;
      cursor: pointer;
    }

    .chat-avatar img,
    .chat-avatar div {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .chat-avatar div {
      background: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-info h3 {
      margin: 0;
      font-size: 17px;
      font-weight: 600;
      line-height: 1.2;
      color: var(--text-main);
    }

    .chat-info span {
      font-size: 12px;
      color: var(--text-sec);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .chat-options-container {
      margin-left: auto;
      position: relative;
    }

    .chat-menu-btn {
      background: none;
      box-shadow: none;
      border: none;
      font-size: 24px;
      color: var(--primary-solid);
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Dropdown Style */
    .chat-dropdown {
      position: absolute;
      top: 50px;
      right: 0;
      width: 240px;
      background: var(--bg-card);
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 100;
      border: 1px solid var(--bg-glass-border);
      padding-top: 5px;
      animation: fadeInMenu 0.2s ease-out forwards;
    }
    
    @keyframes fadeInMenu {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .chat-dropdown.active {
      display: flex;
    }

    .dropdown-item {
      padding: 12px 20px;
      font-size: 14px;
      color: var(--text-main);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-weight: 500;
      box-shadow: none;
    }

    .dropdown-item:hover {
      background: rgba(255, 117, 140, 0.1);
      color: var(--primary-solid);
    }

    .dropdown-item.danger {
      color: #ff4757;
    }

    /* Chat Search Bar */
    .chat-search-bar {
      display: none;
      padding: 10px 15px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--bg-glass-border);
      animation: slideDown 0.2s ease-out;
      flex-shrink: 0;
      position: relative;
    }

    .chat-search-bar.active {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chat-search-bar input {
      flex: 1;
      padding: 8px 15px;
      border-radius: 20px;
      border: 1px solid var(--bg-glass-border);
      font-size: 14px;
      outline: none;
      background: var(--input-field-bg);
      margin: 0;
      color: var(--text-main);
    }
    
    .close-search-btn {
        background: none;
        border:none;
        color: #ff4757;
        box-shadow: none;
        padding: 5px;
    }

    @keyframes slideDown {
      from { transform: translateY(-10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* --- MESSAGES AREA & BACKGROUND --- */
    .messages {
      flex: 1;
      padding: 15px 15px 60px 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      z-index: 1;
    }

    /* üöÄ DOODLE BACKGROUND CONFIGURATION üöÄ */
    .messages::before {
        content: "";
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        /* Local Path */
        background-image: url("img/space-5654794_1280.webp"); 
        background-size: 300px;
        background-repeat: repeat;
        opacity: var(--doodle-opacity);
        pointer-events: none;
        z-index: -1;
        mix-blend-mode: var(--doodle-blend);
    }

    .date-separator {
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-sec);
      margin: 15px 0 5px;
      text-transform: uppercase;
      background: var(--bg-card);
      padding: 4px 12px;
      border-radius: 12px;
      align-self: center;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .time-separator {
        text-align: center;
        font-size: 10px;
        color: var(--text-sec);
        margin-top: 5px;
        margin-bottom: 2px;
        font-weight: 500;
    }

    .msg-row {
      display: flex;
      align-items: center;
      gap: 5px;
      max-width: 80%;
      position: relative;
    }

    .msg-row.hidden-by-search {
      display: none !important;
    }

    .msg-row.me {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .msg-row.other {
      align-self: flex-start;
      flex-direction: row;
    }

    .msg-bubble {
      padding: 12px 18px;
      font-size: 15px;
      line-height: 1.4;
      position: relative;
      word-wrap: break-word;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      border-radius: 20px;
    }

    .msg-row.me .msg-bubble {
      background: var(--primary-gradient);
      color: var(--msg-out-text);
      border-bottom-right-radius: 4px;
      box-shadow: 0 4px 15px rgba(255, 117, 140, 0.2);
    }

    .msg-row.other .msg-bubble {
      background: var(--msg-in-bg);
      color: var(--msg-in-text);
      border-bottom-left-radius: 4px;
    }

    .msg-bubble img {
      border-radius: 12px;
      margin-top: 5px;
      max-width: 100%;
      display: block;
    }

    .like-msg {
      font-size: 35px;
      background: none !important;
      box-shadow: none !important;
      padding: 0;
    }

    .msg-menu-container {
      position: relative;
      opacity: 0;
      transition: opacity 0.2s;
      width: 20px;
      display: flex;
      justify-content: center;
    }

    .msg-row:hover .msg-menu-container {
      opacity: 1;
    }

    .msg-dots-btn {
      background: none;
      border: none;
      font-size: 18px;
      color: var(--text-sec);
      cursor: pointer;
      padding: 0;
      box-shadow: none;
    }

    .msg-delete-popup {
      position: absolute;
      top: -25px;
      background: var(--bg-card);
      padding: 5px 10px;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      display: none;
      z-index: 20;
      font-size: 12px;
      color: #ff4757;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }
    
    /* Typing Indicator */
    .typing-indicator {
        position: absolute; 
        bottom: 80px; 
        left: 20px;
        z-index: 10;
        
        background: var(--msg-in-bg);
        padding: 12px 18px; 
        border-radius: 20px;
        border-bottom-left-radius: 4px; 
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        
        display: none;
        align-items: center;
        justify-content: center;
        
        width: fit-content;
        min-width: 60px;
        height: 45px;
    }
    
    .typing-dots {
        display: flex;
        align-items: center;
        gap: 4px;
        height: 100%;
    }
    
    .typing-dots span {
        width: 7px;
        height: 7px;
        background: var(--primary-solid);
        display: inline-block;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
    }
    
    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }

    /* Input Bar */
    .input-bar {
      min-height: 70px;
      padding: 10px 15px;
      background: var(--input-bar-bg);
      display: flex;
      align-items: center;
      gap: 10px;
      border-top: 1px solid var(--bg-glass-border);
      flex-shrink: 0;
      z-index: 20;
    }

    .icon-btn {
      background: none;
      border: none;
      width: 44px;
      height: 44px;
      font-size: 24px;
      cursor: pointer;
      color: var(--primary-solid);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: none;
      flex-shrink: 0;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .icon-btn:hover {
      background: rgba(255, 117, 140, 0.1);
    }

    .input-wrapper {
      flex: 1;
      background: var(--input-field-bg);
      border-radius: 24px;
      display: flex;
      align-items: center;
      padding: 0 15px;
      height: 46px;
      transition: background 0.2s;
    }

    .input-wrapper:focus-within {
      background: var(--input-field-bg);
      border: 1px solid var(--primary-solid);
    }

    .input-wrapper input {
      width: 100%;
      background: transparent;
      border: none;
      padding: 0;
      margin: 0;
      font-size: 16px;
      color: var(--text-main);
      height: 100%;
    }
    
    .input-wrapper input:focus {
        box-shadow: none;
    }

    #sendBtn,
    #likeBtn {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      flex-shrink: 0;
      box-shadow: none;
    }

    #likeBtn {
      background: transparent;
      font-size: 32px;
      color: var(--primary-solid);
    }

    #sendBtn {
      background: var(--primary-gradient);
      color: white;
      font-size: 18px;
      display: none;
      box-shadow: 0 4px 12px rgba(255, 117, 140, 0.4);
    }

    .hidden {
      display: none !important;
    }

    #fileInput {
      display: none;
    }

    .show-users .users {
      display: flex;
    }

    .show-users .chatbox {
      display: none;
    }

    .show-chat .users {
      display: none;
    }

    .show-chat .chatbox {
      display: flex;
    }

    #filePreviewName {
      font-size: 10px;
      color: var(--primary-solid);
      font-weight: 600;
      max-width: 60px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .login-head{
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 30px;
    }

  </style>
</head>

<body>

  <div id="home">
    <div class="home-card">
      <div class="home-logo">üå∏</div>
      <h1>Bangla Messenger</h1>
      <p>Connect with your friends in a simple & aesthetic way.</p>
      <button id="startBtn">Get Started</button>
    </div>
    
    <div class="footer-text">Made with ‚ù§Ô∏è by <span>Nafis</span></div>
  </div>

  <div id="loginModal" class="modal-overlay" style="display: none;">
    <div class="box">
      <span class="close-btn" onclick="closeLoginAndShowHome()">&times;</span>
      <h2 class="login-head">Welcome Back üíñ</h2>
      <p style="color:#888; margin-bottom: 20px;">Login or Sign up to Join</p>
      <input id="username" type="text" placeholder="Username" />
      <input id="password" type="password" placeholder="Password" />
      <button id="loginBtn" style="width:100%">Continue</button>
    </div>
  </div>

  <div id="profile" style="display: none;">
    <div class="profile-card">
      <button id="logoutBtn" class="logout-btn-circle" title="Logout">‚õî</button>

      <div class="avatar" id="myAvatarDisplay">
        <div>üë§</div>
      </div>

      <div class="profile-name-container">
        <h2 id="profileNameDisplay">User</h2>
        <button id="openEditProfileBtn" class="edit-icon-btn" title="Edit Profile">‚úé</button>
      </div>

      <div class="status-container">
        <div class="green-dot"></div>
        <span>Online</span>
      </div>

      <div style="display:flex; flex-direction:column; gap:12px;">
        <button id="addFriendBtn" class="secondary-btn">Add Friend</button>
        <button id="goToChatsBtn">Go to Chats üí¨</button>
        <button class="secondary-btn" onclick="toggleTheme()" style="font-size:13px;">üåó Switch Theme</button>
      </div>
    </div>
  </div>

  <div id="editProfileModal" class="modal-overlay" style="display: none;">
    <div class="box">
      <span class="close-btn" onclick="closeModal('editProfileModal')">&times;</span>
      <h3>Update Profile</h3>
      <input type="text" id="newUsernameInput" placeholder="New Username" />
      <input type="text" id="newPhotoUrlInput" placeholder="Profile Image URL" />
      <p style="font-size:13px; color:#aaa; margin:10px 0;">OR Upload Image</p>
      <input type="file" id="profilePicUpload" style="font-size:14px;" />
      <button id="saveProfileBtn" style="margin-top:20px; width:100%;">Save Changes</button>
    </div>
  </div>

  <div id="addFriendModal" class="modal-overlay" style="display: none;">
    <div class="box">
      <span class="close-btn" onclick="closeModal('addFriendModal')">&times;</span>
      <h3>Add Friend</h3>
      <p style="color:#888; font-size:14px; margin-bottom:15px;">Search by username</p>
      <input type="text" id="friendUsernameInput" placeholder="Exact Username" />
      <button id="searchFriendBtn" style="width:100%;">Add User</button>
    </div>
  </div>

  <div id="deleteChatModal" class="modal-overlay" style="display: none;">
    <div class="box">
      <span class="close-btn" onclick="closeModal('deleteChatModal')">&times;</span>
      <h3 style="color:#ff4757;">Remove Friend?</h3>
      <p style="color:#666; font-size:14px; margin-bottom:20px;">
        This will remove <b id="deleteTargetName">User</b> from your chat list.
      </p>
      <button id="confirmDeleteBtn" class="danger-btn" style="width:100%;">Yes, Remove</button>
    </div>
  </div>

  <div id="friendProfileModal" class="modal-overlay" style="display: none;">
    <div class="box">
      <span class="close-btn" onclick="closeModal('friendProfileModal')">&times;</span>
      <div class="avatar" id="friendModalAvatar" style="width:100px; height:100px; margin-bottom:15px;"></div>
      <h3 id="friendModalName" style="margin-bottom:5px;">User</h3>
      <p style="color:#aaa; font-size:14px;">Bangla Messenger User</p>
    </div>
  </div>

  <div id="chat" class="show-users" style="display: none;">

    <div class="users">
      <div class="users-header">
        <h2>Chats</h2>
        <button onclick="goToProfile()" class="secondary-btn">Profile</button>
      </div>
      <div id="friendsListContainer" class="friend-list"></div>
    </div>

    <div class="chatbox">
      <div class="chat-header">
        <button class="back-btn" onclick="backToFriends()">‚Üê</button>
        <div class="chat-avatar" id="chatHeaderIcon" onclick="showFriendProfile()"></div>
        <div class="chat-info">
          <h3 id="chatHeaderName">User</h3>
          <span>Active now</span>
        </div>

        <div class="chat-options-container">
            <button class="chat-menu-btn" onclick="toggleChatMenu()">‚ãÆ</button>
            <div class="chat-dropdown" id="chatMenuDropdown">
                <button class="dropdown-item" onclick="showFriendProfile(); toggleChatMenu()">
                   üë§ View Profile
                </button>
                <button class="dropdown-item" onclick="toggleSearch(); toggleChatMenu()">
                   üîç Search
                </button>
                <button class="dropdown-item" onclick="alert('Privacy Policy: End-to-end encrypted locally.'); toggleChatMenu()">
                    üõ° Privacy
                </button>
                <button class="dropdown-item danger" onclick="deleteConversation(); toggleChatMenu()">
                    üóë Delete Chat
                </button>
            </div>
        </div>
      </div>

      <div class="chat-search-bar" id="chatSearchBar">
        <input type="text" id="messageSearchInput" placeholder="Search..." oninput="filterMessages()" />
        <button class="close-search-btn" onclick="closeSearch()" title="Close Search">‚úñ</button>
      </div>

      <div class="messages" id="messages"></div>
      
      <div class="typing-indicator" id="typingIndicator">
          <div class="typing-dots"><span></span><span></span><span></span></div>
      </div>

      <div class="input-bar">
        <input type="file" id="fileInput" onchange="handleFileSelect()" />
        <label for="fileInput" class="icon-btn" title="Send File">üìé</label>

        <span id="filePreviewName"></span>

        <div class="input-wrapper">
          <input id="msgInput" type="text" placeholder="Type a message..." autocomplete="off"
            oninput="handleInput()" />
        </div>

        <button id="likeBtn" class="icon-btn" onclick="sendLike()">üëç</button>
        <button id="sendBtn" onclick="sendMessage()">‚û§</button>
      </div>
    </div>
  </div>

  <script>
    firebase.initializeApp({
      apiKey: "AIzaSyDEdvwTvt-tSuWt5cJN5vInxWhm5gCuefo",
      authDomain: "cryptchat-web.firebaseapp.com",
      projectId: "cryptchat-web"
    });
    const db = firebase.firestore();
    const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dpv173a1d/auto/upload";
    const CLOUDINARY_PRESET = "unsigned_preset";

    let currentUser = null;
    let currentChatFriend = null;
    let unsubscribeMsgs = null;
    let unsubscribeFriends = null;
    let unsubscribeTyping = null;
    let friendToDelete = null;
    let typingTimeout = null;
    
    // --- THEME LOGIC ---
    function toggleTheme() {
        const html = document.documentElement;
        const current = html.getAttribute("data-theme");
        const target = current === "dark" ? "light" : "dark";
        html.setAttribute("data-theme", target);
        localStorage.setItem("theme", target);
    }
    
    // Load saved theme
    const savedTheme = localStorage.getItem("theme");
    if(savedTheme) document.documentElement.setAttribute("data-theme", savedTheme);

    // Helper: Title Case
    function toTitleCase(str) {
        if (!str) return "";
        return str.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }

    window.addEventListener("DOMContentLoaded", () => {
      const storedId = localStorage.getItem("uid");
      if (storedId) fetchUser(storedId);
      else document.getElementById("home").style.display = "flex";

      const loginAction = () => document.getElementById("loginBtn").click();
      document.getElementById("username").addEventListener("keydown", (e) => { if(e.key === "Enter") loginAction(); });
      document.getElementById("password").addEventListener("keydown", (e) => { if(e.key === "Enter") loginAction(); });
    });

    document.getElementById("startBtn").onclick = () => {
      const modal = document.getElementById("loginModal");
      modal.classList.add("active");
      const box = modal.querySelector('.box');
      box.classList.remove('animate-zoom');
      void box.offsetWidth; 
      box.classList.add('animate-zoom');
    };

    function closeLoginAndShowHome() {
      document.getElementById("loginModal").classList.remove("active");
      document.getElementById("home").style.display = "flex";
      document.getElementById("profile").style.display = "none";
      document.getElementById("chat").style.display = "none";
    }

    async function fetchUser(uid) {
      try {
        const doc = await db.collection("users").doc(uid).get();
        if (doc.exists) {
          currentUser = { id: doc.id, ...doc.data() };
          currentUser.username = toTitleCase(currentUser.username); 
          localStorage.setItem("uid", uid);

          document.getElementById("loginModal").classList.remove("active");
          document.getElementById("home").style.display = "none";

          const activeChat = localStorage.getItem("activeChat");
          if (activeChat) {
            const friend = JSON.parse(activeChat);
            showChatInbox(); 
            setupRealTimeFriendList(); 
            openChat(friend); 
          } else {
            showChatInbox(); 
          }

        } else {
          localStorage.clear();
          location.reload();
        }
      } catch (e) { console.error(e); }
    }

    function showChatInbox() {
      document.getElementById("home").style.display = "none";
      document.getElementById("profile").style.display = "none";
      document.getElementById("chat").style.display = "flex";
      backToFriends();
      setupRealTimeFriendList();
    }

    document.getElementById("loginBtn").onclick = async () => {
      const u = document.getElementById("username").value.trim().toLowerCase();
      const p = document.getElementById("password").value;
      if (!u || !p) return alert("Please fill all fields");

      const snap = await db.collection("users").where("username", "==", u).get();
      if (!snap.empty) {
        const doc = snap.docs[0];
        if (doc.data().password === p) {
          fetchUser(doc.id);
        } else {
          alert("Incorrect password");
        }
      } else {
        const ref = await db.collection("users").add({
          username: u, password: p, photoUrl: "", friends: [],
          created: firebase.firestore.FieldValue.serverTimestamp()
        });
        fetchUser(ref.id);
      }
    };

    document.getElementById("logoutBtn").onclick = () => {
      if(!confirm("Are you sure you want to log out?")) return;
      localStorage.clear();
      currentUser = null;
      currentChatFriend = null;
      location.reload();
    };

    function showProfilePage() {
      document.getElementById("profile").style.display = "flex";
      document.getElementById("chat").style.display = "none";
      document.getElementById("home").style.display = "none";

      document.getElementById("profileNameDisplay").textContent = currentUser.username;
      const avatarDiv = document.getElementById("myAvatarDisplay");
      if (currentUser.photoUrl) avatarDiv.innerHTML = `<img src="${currentUser.photoUrl}" />`;
      else avatarDiv.innerHTML = `<div>üë§</div>`;
    }

    document.getElementById("openEditProfileBtn").onclick = () => {
      const modal = document.getElementById("editProfileModal");
      modal.classList.add("active");
      modal.querySelector('.box').classList.add('animate-zoom');
      document.getElementById("newUsernameInput").value = currentUser.username;
      document.getElementById("newPhotoUrlInput").value = currentUser.photoUrl || "";
    };

    document.getElementById("saveProfileBtn").onclick = async () => {
      const newName = document.getElementById("newUsernameInput").value.trim();
      const newNameLower = newName.toLowerCase();
      let newUrl = document.getElementById("newPhotoUrlInput").value.trim();
      const file = document.getElementById("profilePicUpload").files[0];

      if (file) newUrl = await uploadToCloudinary(file);

      if (newNameLower !== currentUser.username.toLowerCase()) {
        const check = await db.collection("users").where("username", "==", newNameLower).get();
        if (!check.empty) return alert("Username taken!");
      }

      await db.collection("users").doc(currentUser.id).update({ username: newNameLower, photoUrl: newUrl });
      
      currentUser.username = toTitleCase(newNameLower);
      currentUser.photoUrl = newUrl;
      closeModal('editProfileModal');
      showProfilePage();
    };

    document.getElementById("addFriendBtn").onclick = () => {
      const modal = document.getElementById("addFriendModal");
      modal.classList.add("active");
      modal.querySelector('.box').classList.add('animate-zoom');
    };

    document.getElementById("searchFriendBtn").onclick = async () => {
      const targetName = document.getElementById("friendUsernameInput").value.trim().toLowerCase();
      if (targetName === currentUser.username.toLowerCase()) return alert("Cannot add yourself.");

      const snap = await db.collection("users").where("username", "==", targetName).get();
      if (snap.empty) return alert("User not found.");

      const friendDoc = snap.docs[0];
      const friendId = friendDoc.id;
      const friendData = friendDoc.data();

      if (!currentUser.friends.includes(friendId)) {
        const myNewFriends = [...currentUser.friends, friendId];
        await db.collection("users").doc(currentUser.id).update({ friends: myNewFriends });
      } else {
        return alert("Already friends!");
      }

      const targetFriends = friendData.friends || [];
      if (!targetFriends.includes(currentUser.id)) {
        const theirNewFriends = [...targetFriends, currentUser.id];
        await db.collection("users").doc(friendId).update({ friends: theirNewFriends });
      }

      alert("Friend added!");
      closeModal('addFriendModal');
      document.getElementById("friendUsernameInput").value = "";
    };

    document.getElementById("goToChatsBtn").onclick = () => {
      showChatInbox();
    };

    function goToProfile() { showProfilePage(); }

    function setupRealTimeFriendList() {
      if (unsubscribeFriends) return;

      const container = document.getElementById("friendsListContainer");

      unsubscribeFriends = db.collection("users").doc(currentUser.id)
        .onSnapshot(async (doc) => {
          const data = doc.data();
          currentUser.friends = data.friends || [];

          if (!currentUser.friends || currentUser.friends.length === 0) {
            container.innerHTML = "<div style='text-align:center;margin-top:40px;color:var(--text-sec);'>No friends yet.<br>Click 'Profile' to add some!</div>";
            return;
          }

          container.innerHTML = "";

          for (const fid of currentUser.friends) {
            const fDoc = await db.collection("users").doc(fid).get();
            if (fDoc.exists) {
              const fData = fDoc.data();
              const div = document.createElement("div");
              div.className = "user-item";

              const imgHTML = fData.photoUrl
                ? `<img src="${fData.photoUrl}">`
                : `<div class="placeholder">üë§</div>`;

              const infoDiv = document.createElement("div");
              infoDiv.className = "user-info-group";
              infoDiv.innerHTML = `${imgHTML} <span>${toTitleCase(fData.username)}</span>`;
              infoDiv.onclick = () => openChat({ id: fDoc.id, ...fData });

              const menuBtn = document.createElement("button");
              menuBtn.className = "user-options-btn";
              menuBtn.innerHTML = "‚ãÆ";
              menuBtn.onclick = (e) => {
                e.stopPropagation();
                showDeleteModal(fDoc.id, fData.username);
              };

              div.appendChild(infoDiv);
              div.appendChild(menuBtn);
              container.appendChild(div);
            }
          }
        });
    }

    function showDeleteModal(fid, fname) {
      friendToDelete = fid;
      document.getElementById("deleteTargetName").textContent = toTitleCase(fname);
      const modal = document.getElementById("deleteChatModal");
      modal.classList.add("active");
      modal.querySelector('.box').classList.add('animate-zoom');
    }

    document.getElementById("confirmDeleteBtn").onclick = async () => {
      if (!friendToDelete) return;
      const newFriends = currentUser.friends.filter(id => id !== friendToDelete);
      await db.collection("users").doc(currentUser.id).update({ friends: newFriends });
      closeModal("deleteChatModal");
    };

    function openChat(friend) {
      currentChatFriend = friend;
      localStorage.setItem("activeChat", JSON.stringify(friend));

      const chatDiv = document.getElementById("chat");
      chatDiv.classList.remove("show-users");
      chatDiv.classList.add("show-chat");

      document.getElementById("chatHeaderName").textContent = toTitleCase(friend.username);
      const iconDiv = document.getElementById("chatHeaderIcon");
      if (friend.photoUrl) iconDiv.innerHTML = `<img src="${friend.photoUrl}">`;
      else iconDiv.innerHTML = `<div>üë§</div>`;

      document.getElementById("chatSearchBar").classList.remove("active");
      document.getElementById("messageSearchInput").value = "";

      setupTypingListener();
      loadMessages();
    }

    function backToFriends() {
      localStorage.removeItem("activeChat");
      const chatDiv = document.getElementById("chat");
      chatDiv.classList.remove("show-chat");
      chatDiv.classList.add("show-users");
      if (unsubscribeMsgs) unsubscribeMsgs();
      if (unsubscribeTyping) unsubscribeTyping();
      currentChatFriend = null;
      
      document.getElementById("chatMenuDropdown").classList.remove("active");
      document.getElementById("chatSearchBar").classList.remove("active");
    }

    function showFriendProfile() {
      if (!currentChatFriend) return;
      const modal = document.getElementById("friendProfileModal");
      modal.classList.add("active");
      modal.querySelector('.box').classList.add('animate-zoom');
      document.getElementById("friendModalName").textContent = toTitleCase(currentChatFriend.username);
      const av = document.getElementById("friendModalAvatar");
      if (currentChatFriend.photoUrl) av.innerHTML = `<img src="${currentChatFriend.photoUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
      else av.innerHTML = `<div style="width:100%;height:100%;border-radius:50%;background:#eee;display:flex;align-items:center;justify-content:center;font-size:40px;">üë§</div>`;
    }

    // --- TYPING INDICATOR LOGIC ---
    function handleInput() {
        toggleSendBtn();
        const chatId = [currentUser.id, currentChatFriend.id].sort().join("_");
        db.collection("chats").doc(chatId).set({
            typing: { [currentUser.id]: true }
        }, { merge: true });

        if (typingTimeout) clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            db.collection("chats").doc(chatId).set({
                typing: { [currentUser.id]: false }
            }, { merge: true });
        }, 1500);
    }

    function setupTypingListener() {
        const chatId = [currentUser.id, currentChatFriend.id].sort().join("_");
        const ind = document.getElementById("typingIndicator");

        unsubscribeTyping = db.collection("chats").doc(chatId).onSnapshot(doc => {
            if(doc.exists) {
                const data = doc.data();
                const typingMap = data.typing || {};
                const isFriendTyping = typingMap[currentChatFriend.id];
                
                if(isFriendTyping) {
                    ind.style.display = "flex";
                } else {
                    ind.style.display = "none";
                }
            }
        });
    }

    function loadMessages() {
      if (unsubscribeMsgs) unsubscribeMsgs();
      const chatId = [currentUser.id, currentChatFriend.id].sort().join("_");
      const msgsDiv = document.getElementById("messages");

      unsubscribeMsgs = db.collection("chats").doc(chatId).collection("msgs")
        .orderBy("time")
        .onSnapshot(snap => {
          msgsDiv.innerHTML = "";
          let lastDate = null;
          let lastTimeStr = null; // Track time

          snap.forEach(doc => {
            const m = doc.data();
            const msgId = doc.id;
            const date = m.time ? m.time.toDate() : new Date();

            const dateStr = date.toDateString();
            const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // 1. DATE HEADER
            if (dateStr !== lastDate) {
              const sep = document.createElement("div");
              sep.className = "date-separator";
              const isToday = new Date().toDateString() === dateStr;
              sep.textContent = isToday ? "Today" : date.toLocaleDateString();
              msgsDiv.appendChild(sep);
              lastDate = dateStr;
              lastTimeStr = null; // Reset time tracker on new day
            }

            // 2. STACKED TIME HEADER (If time changes minute)
            if (timeStr !== lastTimeStr) {
                const timeDiv = document.createElement("div");
                timeDiv.className = "time-separator";
                timeDiv.textContent = timeStr;
                msgsDiv.appendChild(timeDiv);
                lastTimeStr = timeStr;
            }

            // 3. MESSAGE ROW
            const rowDiv = document.createElement("div");
            const isMe = m.sender === currentUser.id;
            rowDiv.className = "msg-row " + (isMe ? "me" : "other");

            if (isMe) {
              // Sender: Menu on Left, Bubble on Right
              const menuContainer = document.createElement("div");
              menuContainer.className = "msg-menu-container";
              menuContainer.innerHTML = `
                            <button class="msg-dots-btn">‚ãÆ</button>
                            <div class="msg-delete-popup" onclick="deleteMessage('${chatId}', '${msgId}')">Delete</div>
                        `;
              const btn = menuContainer.querySelector('.msg-dots-btn');
              const popup = menuContainer.querySelector('.msg-delete-popup');
              btn.onclick = () => { popup.style.display = popup.style.display === 'block' ? 'none' : 'block'; };
              
              const bubble = createBubble(m);
              
              rowDiv.appendChild(bubble); // Bubble 1st
              rowDiv.appendChild(menuContainer); // Menu 2nd (reversed via flex)
            } else {
              // Receiver: Bubble on Left, Menu on Right
              const bubble = createBubble(m);
              
              const menuContainer = document.createElement("div");
              menuContainer.className = "msg-menu-container";
              menuContainer.innerHTML = `
                            <button class="msg-dots-btn">‚ãÆ</button>
                            <div class="msg-delete-popup" style="left:0" onclick="deleteMessage('${chatId}', '${msgId}')">Delete</div>
                        `;
              const btn = menuContainer.querySelector('.msg-dots-btn');
              const popup = menuContainer.querySelector('.msg-delete-popup');
              btn.onclick = () => { popup.style.display = popup.style.display === 'block' ? 'none' : 'block'; };

              rowDiv.appendChild(bubble);
              rowDiv.appendChild(menuContainer);
            }

            msgsDiv.appendChild(rowDiv);
          });
          msgsDiv.scrollTop = msgsDiv.scrollHeight;
          filterMessages();
        });
    }

    function createBubble(m) {
        const bubble = document.createElement("div");
        bubble.className = "msg-bubble";

        let content = "";
        if (m.type === "text") {
            content = m.content;
        } else if (m.type === "file") {
            if (m.fileType && m.fileType.startsWith("image")) {
                content = `<img src="${m.url}">`;
            } else {
                content = `<a href="${m.url}" target="_blank" style="color:inherit;text-decoration:underline;">üìÑ File Attachment</a>`;
            }
        } else if (m.type === "like") {
            bubble.className += " like-msg";
            content = "üëç";
        }
        
        bubble.innerHTML = content;
        return bubble;
    }

    async function deleteMessage(chatId, msgId) {
      if (confirm("Delete this message?")) {
        await db.collection("chats").doc(chatId).collection("msgs").doc(msgId).delete();
      }
    }

    async function sendMessage() {
      const input = document.getElementById("msgInput");
      const txt = input.value.trim();
      const file = document.getElementById("fileInput").files[0];

      if (!txt && !file) return;

      const chatId = [currentUser.id, currentChatFriend.id].sort().join("_");

      if (file) {
        const url = await uploadToCloudinary(file);
        await db.collection("chats").doc(chatId).collection("msgs").add({
          sender: currentUser.id, type: "file", url: url, fileType: file.type,
          time: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById("fileInput").value = "";
        document.getElementById("filePreviewName").textContent = "";
      }

      if (txt) {
        await db.collection("chats").doc(chatId).collection("msgs").add({
          sender: currentUser.id, type: "text", content: txt,
          time: firebase.firestore.FieldValue.serverTimestamp()
        });
        input.value = "";
      }
      
      db.collection("chats").doc(chatId).set({
          typing: { [currentUser.id]: false }
      }, { merge: true });
      
      toggleSendBtn();
    }

    async function sendLike() {
      const chatId = [currentUser.id, currentChatFriend.id].sort().join("_");
      await db.collection("chats").doc(chatId).collection("msgs").add({
        sender: currentUser.id, type: "like",
        time: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    function toggleSendBtn() {
      const txt = document.getElementById("msgInput").value.trim();
      const hasFile = document.getElementById("fileInput").files.length > 0;

      if (txt || hasFile) {
        document.getElementById("sendBtn").style.display = "flex";
        document.getElementById("likeBtn").style.display = "none";
      } else {
        document.getElementById("sendBtn").style.display = "none";
        document.getElementById("likeBtn").style.display = "flex";
      }
    }

    function handleFileSelect() {
      const f = document.getElementById("fileInput").files[0];
      document.getElementById("filePreviewName").textContent = f ? f.name : "";
      toggleSendBtn();
    }

    async function uploadToCloudinary(file) {
      const form = new FormData();
      form.append("file", file);
      form.append("upload_preset", CLOUDINARY_PRESET);
      const res = await fetch(CLOUDINARY_URL, { method: "POST", body: form });
      const data = await res.json();
      return data.secure_url;
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove("active");
    }

    document.getElementById("msgInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });

    window.onclick = function (event) {
      if (event.target.classList.contains('modal-overlay')) {
        event.target.classList.remove("active");
      }
      if (!event.target.closest('.chat-options-container')) {
          document.getElementById("chatMenuDropdown").classList.remove("active");
      }
    }

    function toggleChatMenu() {
        const drop = document.getElementById("chatMenuDropdown");
        drop.classList.toggle("active");
    }

    function toggleSearch() {
        const bar = document.getElementById("chatSearchBar");
        if(!bar.classList.contains("active")) {
            bar.classList.add("active");
            document.getElementById("messageSearchInput").focus();
        } else {
            closeSearch();
        }
    }

    function closeSearch() {
        const bar = document.getElementById("chatSearchBar");
        bar.classList.remove("active");
        const input = document.getElementById("messageSearchInput");
        input.value = "";
        filterMessages(); 
    }

    function filterMessages() {
        const term = document.getElementById("messageSearchInput").value.toLowerCase();
        const bubbles = document.querySelectorAll(".msg-bubble");
        
        bubbles.forEach(b => {
            const row = b.closest(".msg-row");
            if(term === "") {
                row.classList.remove("hidden-by-search");
                return;
            }
            if(b.textContent.toLowerCase().includes(term)) {
                row.classList.remove("hidden-by-search");
            } else {
                row.classList.add("hidden-by-search");
            }
        });
    }

    async function deleteConversation() {
        if(!confirm("Are you sure you want to delete ALL messages in this chat? This cannot be undone.")) return;
        
        const chatId = [currentUser.id, currentChatFriend.id].sort().join("_");
        const msgsRef = db.collection("chats").doc(chatId).collection("msgs");
        
        try {
            const snapshot = await msgsRef.get();
            const batch = db.batch();
            snapshot.docs.forEach((doc) => {
                batch.delete(doc.ref);
            });
            await batch.commit();
            alert("Chat deleted successfully.");
        } catch(e) {
            console.error(e);
            alert("Error deleting chat.");
        }
    }
  </script>
</body>

</html>