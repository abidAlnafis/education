<!DOCTYPE html>
<html lang="en">
<head>
<<<<<<< HEAD
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Æ‡ßá‡¶∏‡ßá‡¶û‡ßç‡¶ú‡¶æ‡¶∞</title>
=======
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Encrypted Chat</title>
>>>>>>> e395bb40245a93f33ba80760a6392be8c127312f

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
<<<<<<< HEAD
   /* Reset & base */
   html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f2f5;
    color: #222;
  }
  body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  /* Homepage */
  #home {
    flex: 1 0 auto;
    display: flex;
    justify-content: center;
    align-items: center;
    background: linear-gradient(135deg, #1d82f5, #00c6ff);
    color: white;
    font-size: 3rem;
    font-weight: 700;
    letter-spacing: 2px;
    user-select: none;
    flex-direction: column;
    padding: 20px;
    text-align: center;
    min-height: 100vh;
    box-sizing: border-box;
  }
  #home small {
    font-size: 1.2rem;
    margin-top: 8px;
    font-weight: 400;
    opacity: 0.85;
  }
  #startBtn {
    margin-top: 30px;
    padding: 12px 40px;
    font-size: 1.1rem;
    font-weight: 700;
    color: #0084ff;
    background: white;
    border: none;
    border-radius: 28px;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(0,132,255,0.4);
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  #startBtn:hover {
    background-color: #e6f0ff;
  }

  /* LOGIN */
  #login {
    flex: 1 0 auto;
    display: none;
    justify-content: center;
    align-items: center;
    background: #fff;
    min-height: 100vh;
    padding: 20px;
    box-sizing: border-box;
  }
  .box {
    background: white;
    padding: 40px 35px;
    max-width: 360px;
    width: 100%;
    border-radius: 12px;
    box-shadow: 0 14px 28px rgba(0,0,0,0.1), 0 10px 10px rgba(0,0,0,0.07);
    text-align: center;
  }
  .box h2 {
    margin: 0 0 20px;
    font-weight: 700;
    color: #333;
    font-size: 28px;
  }
  input {
    width: 100%;
    padding: 14px 18px;
    margin: 10px 0 20px;
    font-size: 16px;
    border: 1.8px solid #ddd;
    border-radius: 28px;
    outline: none;
    transition: border-color 0.3s ease;
    box-sizing: border-box;
  }
  input:focus {
    border-color: #0084ff;
    box-shadow: 0 0 8px rgba(0, 132, 255, 0.3);
  }
  button {
    width: 100%;
    padding: 14px 0;
    font-size: 17px;
    font-weight: 700;
    color: white;
    background: #0084ff;
    border: none;
    border-radius: 28px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    box-shadow: 0 5px 15px rgba(0,132,255,0.4);
  }
  button:hover {
    background: #006edc;
    box-shadow: 0 7px 20px rgba(0,110,220,0.6);
  }

  /* CHAT */
  #chat {
    display: none;
    flex: 1 1 auto;
    height: 100vh;
    box-sizing: border-box;
  }
  #chat {
    display: flex;
    height: 100vh;
    overflow: hidden;
  }
  .users {
    width: 220px;
    background: #fff;
    border-right: 1px solid #ddd;
    overflow-y: auto;
    box-sizing: border-box;
  }
  .users div {
    padding: 15px 20px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    transition: background 0.2s ease;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .users div:hover {
    background: #f5f5f5;
  }
  .users .selected {
    background: #0084ff;
    color: white;
  }
  .chatbox {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: white;
    box-sizing: border-box;
  }
  .header {
    padding: 15px 20px;
    border-bottom: 1px solid #ddd;
    font-weight: bold;
    font-size: 1.1rem;
  }
  .messages {
    flex: 1;
    padding: 15px 20px;
    overflow-y: auto;
    box-sizing: border-box;
    background: #fafafa;
  }
  .msg {
    padding: 10px 14px;
    margin-bottom: 10px;
    max-width: 60%;
    border-radius: 12px;
    word-wrap: break-word;
    font-size: 15px;
    line-height: 1.3;
  }
  .me {
    background: #0084ff;
    color: white;
    margin-left: auto;
  }
  .other {
    background: #e4e6eb;
  }

  .input {
    display: flex;
    align-items: center;
    padding: 10px 20px;
    border-top: 1px solid #ddd;
    background: #fff;
    box-sizing: border-box;
  }

  .input input[type="text"] {
    flex: 1;
    height: 44px;
    line-height: 44px;
    font-size: 16px;
    padding: 0 16px;
    border-radius: 22px;
    border: 1px solid #ccc;
    background-color: #ffffff !important;
    color: #000000 !important;
    caret-color: #000000;
    outline: none;
    box-sizing: border-box;
  }

  .input button {
    margin-left: 10px;
    height: 44px;
    padding: 0 20px;
    border-radius: 22px;
    background: #0084ff;
    border: none;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease;
    flex-shrink: 0;
  }
  .input button:hover {
    background: #006edc;
  }
  #sendBtn { width: auto; }
  .msgInput {
    min-width: 90px;
  }

  /* file input style */
  .file-upload {
    margin-left: 10px;
    width: auto;
    max-width: 112px;
    flex-shrink: 0;
  }

  /* Scrollbar for users and messages */
  .users::-webkit-scrollbar, .messages::-webkit-scrollbar {
    width: 8px;
  }
  .users::-webkit-scrollbar-thumb, .messages::-webkit-scrollbar-thumb {
    background-color: rgba(0,0,0,0.1);
    border-radius: 4px;
  }
=======
body { margin:0; font-family:Arial; background:#f0f2f5 }
#login,#chat { height:100vh; display:none }
#login { display:flex; align-items:center; justify-content:center }
.box { background:#fff; padding:30px; width:320px; border-radius:8px; box-shadow:0 0 10px #ccc }
input,button { width:100%; padding:10px; margin-top:10px; font-size:16px; box-sizing:border-box }
button { background:#0084ff; color:#fff; border:none; cursor:pointer }
#chat { display:flex }
.users { width:220px; background:#fff; border-right:1px solid #ddd; overflow:auto }
.users div { padding:15px; cursor:pointer; border-bottom:1px solid #eee }
.users div:hover { background:#f5f5f5 }
.users .selected { background:#0084ff; color:white }
.chatbox { flex:1; display:flex; flex-direction:column; background:white }
.header { padding:15px; border-bottom:1px solid #ddd; font-weight:bold }
.messages { flex:1; padding:15px; overflow:auto }
.msg { padding:10px; margin-bottom:10px; max-width:60%; border-radius:12px; word-wrap:break-word }
.me { background:#0084ff; color:white; margin-left:auto }
.other { background:#e4e6eb }
.input { display:flex; padding:10px; border-top:1px solid #ddd }
.input input {
  flex:1;
  font-size:18px;
  padding:12px 20px;
  border-radius:25px;
  border:1px solid #ccc;
}
.input button { margin-left:10px; border-radius:20px }
>>>>>>> e395bb40245a93f33ba80760a6392be8c127312f
</style>
</head>
<body>

<<<<<<< HEAD
<!-- HOME -->
<div id="home">
  ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Æ‡ßá‡¶∏‡ßá‡¶û‡ßç‡¶ú‡¶æ‡¶∞
  <small>Secure & Encrypted Chat for Everyone</small>
  <button id="startBtn" style="
    margin-top: 30px;
    padding: 12px 30px;
    font-size: 1.1rem;
    font-weight: 700;
    color: #0084ff;
    background: white;
    border: none;
    border-radius: 28px;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(0,132,255,0.4);
    transition: background-color 0.3s ease, color 0.3s ease;
  ">Get Started</button>
</div>

=======
>>>>>>> e395bb40245a93f33ba80760a6392be8c127312f
<!-- LOGIN -->
<div id="login">
  <div class="box">
    <h2>Login / Register</h2>
<<<<<<< HEAD
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
=======
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
>>>>>>> e395bb40245a93f33ba80760a6392be8c127312f
    <button id="loginBtn">Continue</button>
  </div>
</div>

<!-- CHAT -->
<div id="chat">
  <div class="users" id="users"></div>
  <div class="chatbox">
    <div class="header" id="chatHeader">Select a user</div>
    <div class="messages" id="messages"></div>
    <div class="input" id="inputArea" style="display:none">
<<<<<<< HEAD
      <input id="msgInput" class="msgInput" type="text" placeholder="Type message..." autocomplete="off" />
      <input type="file" id="fileInput" class="file-upload" />
=======
      <input id="msgInput" placeholder="Type message...">
>>>>>>> e395bb40245a93f33ba80760a6392be8c127312f
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<script>
/* ---------------- Firebase ---------------- */
firebase.initializeApp({
  apiKey: "AIzaSyDEdvwTvt-tSuWt5cJN5vInxWhm5gCuefo",
  authDomain: "cryptchat-web.firebaseapp.com",
  projectId: "cryptchat-web"
});
const db = firebase.firestore();

/* ---------------- Globals ---------------- */
let currentUserId = null;
let selectedChatUser = null;
let cryptoKey = null;
<<<<<<< HEAD
let unsubscribeMessages = null;
=======
>>>>>>> e395bb40245a93f33ba80760a6392be8c127312f

/* ---------------- Encryption ---------------- */
async function getKey() {
  if (cryptoKey) return cryptoKey;

  const enc = new TextEncoder();
  const secret = [currentUserId, selectedChatUser.id].sort().join(":");

  const baseKey = await crypto.subtle.importKey(
    "raw",
    enc.encode(secret),
    "PBKDF2",
    false,
    ["deriveKey"]
  );

  cryptoKey = await crypto.subtle.deriveKey(
    {
      name: "PBKDF2",
      salt: enc.encode("chat-app-salt"),
      iterations: 100000,
      hash: "SHA-256"
    },
    baseKey,
    { name: "AES-GCM", length: 256 },
    false,
    ["encrypt", "decrypt"]
  );
  return cryptoKey;
}

async function encryptMessage(text) {
  const key = await getKey();
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const data = new TextEncoder().encode(text);
  const cipher = await crypto.subtle.encrypt({ name:"AES-GCM", iv }, key, data);
  return { c:[...new Uint8Array(cipher)], iv:[...iv] };
}

async function decryptMessage(c, iv) {
  try {
    const key = await getKey();
    const data = await crypto.subtle.decrypt(
      { name:"AES-GCM", iv:new Uint8Array(iv) },
      key,
      new Uint8Array(c)
    );
    return new TextDecoder().decode(data);
<<<<<<< HEAD
  } catch (e) {
    console.error("Decrypt failed for c:", c, "iv:", iv, e);
=======
  } catch {
>>>>>>> e395bb40245a93f33ba80760a6392be8c127312f
    return "[decrypt failed]";
  }
}

<<<<<<< HEAD
/* ---------------- Homepage -> Login transition ---------------- */
const home = document.getElementById("home");
const login = document.getElementById("login");
const chat = document.getElementById("chat");
const startBtn = document.getElementById("startBtn");

startBtn.onclick = () => {
  home.style.display = "none";
  login.style.display = "flex";
};

/* ---------------- Login / Register ---------------- */
const loginBtn = document.getElementById("loginBtn");

loginBtn.onclick = async () => {
  const e = email.value.trim().toLowerCase();
  const p = password.value;

  if (!e || !p) {
=======
/* ---------------- Login / Register ---------------- */
loginBtn.onclick = async () => {
  const emailVal = document.getElementById("email").value.trim().toLowerCase();
  const passVal  = document.getElementById("password").value;

  if (!emailVal || !passVal) {
>>>>>>> e395bb40245a93f33ba80760a6392be8c127312f
    alert("Fill all fields");
    return;
  }

<<<<<<< HEAD
  try {
    const snap = await db.collection("users").where("email", "==", e).get();

    if (!snap.empty) {
      let userDoc = null;
      snap.forEach(d => { if (!userDoc) userDoc = d; });

      if (userDoc.data().password !== p) {
        alert("Wrong password");
        return;
      }
      currentUserId = userDoc.id;
    } else {
      const u = await db.collection("users").add({
        email: e,
        password: p,
        created: firebase.firestore.FieldValue.serverTimestamp()
      });
      currentUserId = u.id;
    }

    login.style.display = "none";
    chat.style.display = "flex";
    loadUsers();

  } catch (err) {
    console.error("LOGIN ERROR:", err);
    alert("Login failed. Check console.");
=======
  const q = await db.collection("users")
    .where("email", "==", emailVal)
    .get();

  if (!q.empty) {
    if (q.docs[0].data().password !== passVal) {
      alert("Wrong password");
      return;
    }
    currentUserId = q.docs[0].id;
  } else {
    const u = await db.collection("users").add({
      email: emailVal,
      password: passVal
    });
    currentUserId = u.id;
>>>>>>> e395bb40245a93f33ba80760a6392be8c127312f
  }
};

<<<<<<< HEAD
/* ---------------- Users ---------------- */
const users = document.getElementById("users");
const chatHeader = document.getElementById("chatHeader");
const inputArea = document.getElementById("inputArea");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const messages = document.getElementById("messages");

=======
  login.style.display = "none";
  chat.style.display = "flex";
  loadUsers();
};

/* ---------------- Users ---------------- */
>>>>>>> e395bb40245a93f33ba80760a6392be8c127312f
function loadUsers() {
  db.collection("users").onSnapshot(s => {
    users.innerHTML = "";
    s.forEach(d => {
      if (d.id === currentUserId) return;
      const div = document.createElement("div");
      div.textContent = d.data().email;
      div.onclick = () => selectUser(d.id, d.data().email, div);
      users.appendChild(div);
<<<<<<< HEAD
    });
  });
}

function selectUser(id, email, el) {
  selectedChatUser = { id, email };
  cryptoKey = null;
  chatHeader.textContent = "Chat with " + email + " üîí";
  inputArea.style.display = "flex";
  [...users.children].forEach(c => c.classList.remove("selected"));
  el.classList.add("selected");
  loadMessages();
  msgInput.focus();
}

/* ---------------- Messages ---------------- */
function chatId() {
  return [currentUserId, selectedChatUser.id].sort().join("_");
}

function loadMessages() {
  if (unsubscribeMessages) unsubscribeMessages();

  messages.innerHTML = "";
  if (!currentUserId || !selectedChatUser) {
    console.warn("No user selected for messages");
    return;
  }
  
  const cid = chatId();

  const chatRef = db.collection("chats").doc(cid).collection("msgs").orderBy("time");

  unsubscribeMessages = chatRef.onSnapshot(async snapshot => {
    messages.innerHTML = "";

    for (const doc of snapshot.docs) {
      const m = doc.data();
      const div = document.createElement("div");
      div.className = "msg " + (m.sender === currentUserId ? "me" : "other");

      if (m.type === "text" && m.c && m.iv && selectedChatUser) {
        div.textContent = await decryptMessage(m.c, m.iv);
      } else if (m.type === "file" && m.url) {
        if (m.fileType?.startsWith("image")) {
          div.innerHTML = `<img src="${m.url}" style="max-width: 100%; border-radius:8px;">`;
        } else if (m.fileType?.startsWith("video")) {
          div.innerHTML = `<video src="${m.url}" controls style="max-width: 100%; border-radius:8px;"></video>`;
        } else {
          div.innerHTML = `<a href="${m.url}" target="_blank" rel="noopener">üìÑ ${m.name || "File"}</a>`;
        }
      } else {
        div.textContent = "[unsupported message]";
      }
      messages.appendChild(div);
    }

    messages.scrollTop = messages.scrollHeight;
  });
}

/* ---------------- Send ---------------- */
sendBtn.onclick = async () => {
  const text = msgInput.value.trim();
  const fileInput = document.getElementById('fileInput');
  if (!selectedChatUser) return;

  // Upload file if present
  if (fileInput.files.length > 0) {
    const file = fileInput.files[0];
    const url = await uploadFileToCloudinary(file);
    if (!url) {
      alert("File upload failed");
      return;
    }

    await db.collection("chats").doc(chatId()).collection("msgs").add({
      sender: currentUserId,
      type: "file",
      url,
      fileType: file.type,
      name: file.name,
      time: firebase.firestore.FieldValue.serverTimestamp()
    });

    fileInput.value = "";
  }

  // Encrypt and send text message
  if (text) {
    const e = await encryptMessage(text);
    await db.collection("chats").doc(chatId()).collection("msgs").add({
      sender: currentUserId,
      type: "text",
=======
    });
  });
}

function selectUser(id, email, el) {
  selectedChatUser = { id, email };
  cryptoKey = null;
  chatHeader.textContent = "Chat with " + email + " üîí";
  inputArea.style.display = "flex";
  [...users.children].forEach(c => c.classList.remove("selected"));
  el.classList.add("selected");
  loadMessages();
  msgInput.focus();
}

/* ---------------- Messages ---------------- */
function chatId() {
  return [currentUserId, selectedChatUser.id].sort().join("_");
}

function loadMessages() {
  messages.innerHTML = "";
  db.collection("chats").doc(chatId())
    .collection("msgs").orderBy("time")
    .onSnapshot(async s => {
      messages.innerHTML = "";
      for (const d of s.docs) {
        const m = d.data();
        const text = await decryptMessage(m.c, m.iv);
        const div = document.createElement("div");
        div.className = "msg " + (m.sender === currentUserId ? "me":"other");
        div.textContent = text;
        messages.appendChild(div);
      }
      messages.scrollTop = messages.scrollHeight;
    });
}

/* ---------------- Send ---------------- */
sendBtn.onclick = async () => {
  const text = msgInput.value.trim();
  if (!text || !selectedChatUser) return;

  const e = await encryptMessage(text);
  await db.collection("chats").doc(chatId())
    .collection("msgs").add({
      sender: currentUserId,
>>>>>>> e395bb40245a93f33ba80760a6392be8c127312f
      c: e.c,
      iv: e.iv,
      time: firebase.firestore.FieldValue.serverTimestamp()
    });
<<<<<<< HEAD
    msgInput.value = "";
  }

=======

  msgInput.value = "";
>>>>>>> e395bb40245a93f33ba80760a6392be8c127312f
  msgInput.focus();
};

msgInput.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    sendBtn.click();
  }
});

<<<<<<< HEAD
/* ---------------- Cloudinary upload ---------------- */
async function uploadFileToCloudinary(file) {
  const url = "https://api.cloudinary.com/v1_1/dpv173a1d/auto/upload";
  const preset = "unsigned_preset";

  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", preset);

  try {
    const res = await fetch(url, {
      method: "POST",
      body: formData
    });
    const data = await res.json();
    if (data.secure_url) {
      return data.secure_url;
    } else {
      console.error("Cloudinary upload error:", data);
      return null;
    }
  } catch (err) {
    console.error("Cloudinary upload failed:", err);
    return null;
  }
}

/* ---------------- Start ---------------- */
// Start with homepage visible, login and chat hidden
home.style.display = "flex";
login.style.display = "none";
chat.style.display = "none";
=======
/* ---------------- Start ---------------- */
login.style.display = "flex";
>>>>>>> e395bb40245a93f33ba80760a6392be8c127312f
</script>
</body>
</html>
